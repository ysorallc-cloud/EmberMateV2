<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HealthTracker Pro - Personal Health Management</title>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             img-src 'self' data:;
             style-src 'self' 'unsafe-inline';
             script-src 'self' 'unsafe-inline';
             connect-src 'self';
             font-src 'self' data:;
             frame-ancestors 'none';
             base-uri 'self';
             form-action 'self'">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíä</text></svg>">
</head>

<body>
  <!-- Toast Notifications -->
  <div id="toast-region" aria-live="polite" aria-atomic="true" class="toast-region"></div>

  <!-- HIPAA Disclaimer Modal -->
  <div id="hipaa-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ö†Ô∏è Important Privacy Notice</h2>
      </div>
      <div class="modal-body">
        <h3>HIPAA Compliance Disclaimer</h3>
        <p><strong>This application is NOT HIPAA compliant and should not be used to store Protected Health Information (PHI) that requires HIPAA compliance.</strong></p>
        
        <h4>What This Means:</h4>
        <ul>
          <li>This is a personal tracking tool for your own use</li>
          <li>Data is stored locally in your browser only</li>
          <li>We do not transmit your health data to any servers</li>
          <li>This tool is not a substitute for professional medical advice</li>
          <li>Always consult with healthcare professionals about your health</li>
        </ul>

        <h4>Your Privacy:</h4>
        <ul>
          <li>All data is stored locally on your device</li>
          <li>You can export and delete your data at any time</li>
          <li>Clear your browser data to remove all information</li>
          <li>Use the export feature to create backups</li>
        </ul>

        <h4>Security Recommendations:</h4>
        <ul>
          <li>Do not use on shared or public computers</li>
          <li>Keep your device password-protected</li>
          <li>Regularly backup your data using the export feature</li>
          <li>Do not share sensitive health information via unsecured channels</li>
        </ul>

        <div class="checkbox-container">
          <label>
            <input type="checkbox" id="hipaa-acknowledge" />
            I understand that this application is not HIPAA compliant and I agree to use it at my own discretion for personal health tracking only.
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="hipaa-accept" disabled>Accept & Continue</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- Sidebar Navigation -->
    <nav class="sidenav" aria-label="Primary">
      <div class="brand">
        <span class="brand-icon">üíä</span>
        <span>HealthTracker Pro</span>
      </div>
      <ul>
        <li><a href="#dashboard" data-nav aria-current="page">üìä Dashboard</a></li>
        <li><a href="#medications" data-nav>üíä Medications</a></li>
        <li><a href="#vitals" data-nav>‚ù§Ô∏è Vitals</a></li>
        <li><a href="#symptoms" data-nav>üìù Symptoms & Side Effects</a></li>
        <li><a href="#weight" data-nav>‚öñÔ∏è Weight Tracking</a></li>
        <li><a href="#goals" data-nav>üéØ Goals & Achievements</a></li>
        <li><a href="#bulk-entry" data-nav>üìã Bulk Data Entry</a></li>
        <li><a href="#reports" data-nav>üìà Reports & Export</a></li>
        <li><a href="#settings" data-nav>‚öôÔ∏è Settings</a></li>
      </ul>
      <div class="sidenav-footer">
        <button class="btn btn-small" id="quick-export">Quick Export</button>
        <button class="btn btn-small" id="view-hipaa">Privacy Notice</button>
      </div>
    </nav>

    <main id="main" class="main" role="main">
      <p>Loading application...</p>
    </main>
  </div>

  <!-- Load external JS modules -->
  <script src="./js/store.js"></script>
  <script src="./js/consent.js"></script>
  <script src="./js/nav.js"></script>
  <script src="./js/telemetry.js"></script>
  <script src="./js/sampling.js"></script>
  <script src="./js/app.js"></script>
  <script src="./js/app-enhanced.js"></script>

  <!-- Sample Data Auto-Loader -->
  <script>
  (async function() {
    const SAMPLE_DATA_LOADED_KEY = 'sampleDataLoaded';
    const SAMPLE_DATA_VERSION_KEY = 'sampleDataVersion';
    const CURRENT_VERSION = '1.0.0';

    // Check if sample data has already been loaded
    const hasLoadedSampleData = localStorage.getItem(SAMPLE_DATA_LOADED_KEY);
    const loadedVersion = localStorage.getItem(SAMPLE_DATA_VERSION_KEY);

    // Only load sample data if:
    // 1. Never loaded before, OR
    // 2. Version has changed
    if (hasLoadedSampleData === 'true' && loadedVersion === CURRENT_VERSION) {
      console.log('Sample data already loaded (version ' + CURRENT_VERSION + ')');
      return;
    }

    // Check if user already has data (don't overwrite existing data)
    const hasExistingData = localStorage.getItem('medications') || 
                           localStorage.getItem('vitals') || 
                           localStorage.getItem('appointments');

    if (hasExistingData && hasLoadedSampleData !== 'true') {
      console.log('User has existing data, skipping sample data load');
      localStorage.setItem(SAMPLE_DATA_LOADED_KEY, 'true');
      localStorage.setItem(SAMPLE_DATA_VERSION_KEY, CURRENT_VERSION);
      return;
    }

    try {
      // Fetch sample data from sample-data.json
      const response = await fetch('./sample-data.json');
      
      if (!response.ok) {
        console.warn('Sample data file not found or could not be loaded');
        return;
      }

      const sampleData = await response.json();
      console.log('Loading sample data...');

      // Load each data type into localStorage
      if (sampleData.medications) {
        localStorage.setItem('medications', JSON.stringify(sampleData.medications));
        console.log('‚úì Loaded ' + sampleData.medications.length + ' sample medications');
      }

      if (sampleData.vitals) {
        localStorage.setItem('vitals', JSON.stringify(sampleData.vitals));
        console.log('‚úì Loaded ' + sampleData.vitals.length + ' sample vitals entries');
      }

      if (sampleData.appointments) {
        localStorage.setItem('appointments', JSON.stringify(sampleData.appointments));
        console.log('‚úì Loaded ' + sampleData.appointments.length + ' sample appointments');
      }

      if (sampleData.symptoms) {
        localStorage.setItem('symptoms', JSON.stringify(sampleData.symptoms));
        console.log('‚úì Loaded ' + sampleData.symptoms.length + ' sample symptoms');
      }

      if (sampleData.notes) {
        localStorage.setItem('notes', JSON.stringify(sampleData.notes));
        console.log('‚úì Loaded ' + sampleData.notes.length + ' sample notes');
      }

      if (sampleData.weight) {
        localStorage.setItem('weight', JSON.stringify(sampleData.weight));
        console.log('‚úì Loaded ' + sampleData.weight.length + ' sample weight entries');
      }

      if (sampleData.goals) {
        localStorage.setItem('goals', JSON.stringify(sampleData.goals));
        console.log('‚úì Loaded ' + sampleData.goals.length + ' sample goals');
      }

      // Mark sample data as loaded with version
      localStorage.setItem(SAMPLE_DATA_LOADED_KEY, 'true');
      localStorage.setItem(SAMPLE_DATA_VERSION_KEY, CURRENT_VERSION);

      console.log('‚úì Sample data loaded successfully!');
      
      // Show success notification if toast function is available
      if (typeof showToast === 'function') {
        showToast('‚úì Sample data loaded successfully! Explore the app to see example entries.', 'success');
      }

    } catch (error) {
      console.error('Error loading sample data:', error);
      // Don't block app loading if sample data fails
    }
  })();
  </script>

  <!-- Quick Export Utility -->
  <script>
  (function() {
    const quickExportBtn = document.getElementById('quick-export');
    const viewHipaaBtn = document.getElementById('view-hipaa');
    
    if (quickExportBtn) {
      quickExportBtn.addEventListener('click', function() {
        const data = {
          medications: JSON.parse(localStorage.getItem('medications') || '[]'),
          vitals: JSON.parse(localStorage.getItem('vitals') || '[]'),
          appointments: JSON.parse(localStorage.getItem('appointments') || '[]'),
          symptoms: JSON.parse(localStorage.getItem('symptoms') || '[]'),
          notes: JSON.parse(localStorage.getItem('notes') || '[]'),
          weight: JSON.parse(localStorage.getItem('weight') || '[]'),
          goals: JSON.parse(localStorage.getItem('goals') || '[]'),
          exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'healthtracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        if (typeof showToast === 'function') {
          showToast('‚úì Data exported successfully', 'success');
        }
      });
    }

    if (viewHipaaBtn) {
      viewHipaaBtn.addEventListener('click', function() {
        const modal = document.getElementById('hipaa-modal');
        if (modal) {
          modal.style.display = 'flex';
          
          // Reset checkbox state
          const checkbox = document.getElementById('hipaa-acknowledge');
          const acceptBtn = document.getElementById('hipaa-accept');
          if (checkbox) checkbox.checked = false;
          if (acceptBtn) acceptBtn.disabled = true;
          
          // Add temporary close button text
          if (acceptBtn) acceptBtn.textContent = 'Close';
          acceptBtn.onclick = function() {
            modal.style.display = 'none';
          };
        }
      });
    }
  })();
  </script>

  <!-- Import Data Utility -->
  <script>
  function importData() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = 
      '<div class="modal-content">' +
      '<div class="modal-header">' +
      '<h2>üì• Import Backup Data</h2>' +
      '</div>' +
      '<div class="modal-body">' +
      '<p>Select a backup JSON file to import your health data.</p>' +
      '<p><strong>Warning:</strong> This will overwrite your current data.</p>' +
      '<input type="file" id="import-file-input" accept=".json" />' +
      '</div>' +
      '<div class="modal-footer">' +
      '<button class="btn btn-secondary" onclick="this.closest(\'.modal\').remove()">Cancel</button>' +
      '<button class="btn btn-primary" id="import-confirm-btn">Import</button>' +
      '</div>' +
      '</div>';
    
    document.body.appendChild(modal);
    
    const fileInput = document.getElementById('import-file-input');
    const confirmBtn = document.getElementById('import-confirm-btn');
    
    confirmBtn.onclick = function() {
      const file = fileInput.files[0];
      if (!file) {
        if (typeof showToast === 'function') {
          showToast('Please select a file', 'error');
        }
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Import each data type
          if (data.medications) localStorage.setItem('medications', JSON.stringify(data.medications));
          if (data.vitals) localStorage.setItem('vitals', JSON.stringify(data.vitals));
          if (data.appointments) localStorage.setItem('appointments', JSON.stringify(data.appointments));
          if (data.symptoms) localStorage.setItem('symptoms', JSON.stringify(data.symptoms));
          if (data.notes) localStorage.setItem('notes', JSON.stringify(data.notes));
          if (data.weight) localStorage.setItem('weight', JSON.stringify(data.weight));
          if (data.goals) localStorage.setItem('goals', JSON.stringify(data.goals));
          
          if (typeof showToast === 'function') {
            showToast('‚úì Data imported successfully! Refreshing...', 'success');
          }
          
          setTimeout(() => window.location.reload(), 1500);
        } catch (err) {
          console.error('Import error:', err);
          if (typeof showToast === 'function') {
            showToast('‚ùå Invalid JSON file', 'error');
          }
        }
      };
      reader.readAsText(file);
      modal.remove();
    };
    
    modal.onclick = function(e) {
      if (e.target === modal) modal.remove();
    };
  }

  // Add CSS animation
  const style = document.createElement('style');
  style.textContent = 
    '@keyframes slideIn {' +
    'from { transform: translateX(400px); opacity: 0; }' +
    'to { transform: translateX(0); opacity: 1; }' +
    '}';
  document.head.appendChild(style);
  </script>

</body>
</html>
