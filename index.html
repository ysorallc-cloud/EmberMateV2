<!DOCTYPE html>
<!-- EmberMate V2.14 - UC9 & UC10 - Updated: 2025-10-30 
     
     ⚠️ DEMONSTRATION MODE - ALL DATA FICTIONAL & ANONYMIZED ⚠️
     This version contains no Protected Health Information (PHI).
     All names, medical values, medications, and personal data are generic placeholders.
     
     V2.14 UC9 & UC10:
     ✓ UC9: Analytics charts update dynamically without page refresh
     ✓ UC9: Chart.js instances properly destroyed/recreated on render
     ✓ UC9: Vitals table shows all logged readings in real-time
     ✓ UC10: Debug panel toggled via ?debug=1 or Ctrl+Shift+D
     ✓ UC10: DEV indicator chip shows when debug active
     ✓ UC10: Debug tab hidden when leaving debug mode
     ✓ UC10: Quick dev actions (seed demo data, etc.)
     
     V2.13.2 UC7 & UC8 FIX:
     ✓ UC7: Import now preserves imported version → migration runs on reload
     ✓ UC7: Unversioned imports default to v2.9.0 to trigger migrations
     ✓ UC8: PHI detection returns 'detected' property for test validation
     ✓ UC8: testPHIWarnings() now works correctly
     
     V2.13.1 UC3 & UC4 FIX:
     ✓ UC3: Vitals quick-add shows inline confirmation in modal (not toast spam)
     ✓ UC3: Timeline updates immediately with new entry for current profile
     ✓ UC4: "Meds Done" creates real timeline entry tagged to current profile
     ✓ UC4: Single toast only, no secondary popups
     
     V2.13 UX REFINEMENTS:
     ✓ Selective toast notifications (big actions only)
     ✓ Inline confirmations for vitals/mood/meds (calmer UX)
     ✓ Mode-aware AI summary (caregiver vs patient language)
     ✓ Import/export status display
     ✓ Visual DEV mode indicator when debug active
     
     V2.12 ADDITIONS:
     ✓ Mode-aware home button in header (Caregiver Home / My Health)
     ✓ Data import step in onboarding (MyChart warning, backup import, manual entry)
     ✓ Developer/QA debug panel (access via ?debug=1 or Ctrl+Shift+D)
     ✓ Test matrix checklist, app state inspector, quick dev actions
     
     PHI GUARDS (V2.11):
     ✓ Client-side PHI pattern detection in note fields
     ✓ Warnings for: phone numbers, emails, SSN, DOB, addresses, MRN
     ✓ Length check (300 char limit) on all notes
     ✓ Profile banner: "Personal tracker, not clinical record"
     ✓ Non-blocking warnings (data still saves, user informed)
     
     DATA MANAGEMENT (V2.10):
     ✓ Version tracking & automatic data migration
     ✓ Export all data to JSON (profiles + entries + archived)
     ✓ Import data from JSON backup files
     ✓ Backward compatible with unversioned data
     
     ROLE-AWARE UI (V2.9):
     ✓ Visual role indicator chip in header
     ✓ Dynamic caregiver/patient view switching
     ✓ Caregiver quick actions auto-hide in patient mode
     ✓ "For: [profile]" labels in all caregiver forms
     ✓ Improved role context throughout interface
     
     PRODUCTION BASELINE - Profile-aware optimization & QA-ready:
     ✓ Profile-aware data limits (1,000 entries per profile max)
     ✓ Smart archiving with user notifications
     ✓ Test attributes for QA automation (data-test="*")
     ✓ Improved caregiver-focused copy
     ✓ Large text support (125-150% zoom)
     ✓ Accessibility: reduced motion, high contrast, ARIA
     
     DE-IDENTIFICATION APPLIED:
     ✓ Generic user names and avatars
     ✓ Anonymized medical values and ranges
     ✓ Generic medication names (Medication A, B, etc.)
     ✓ Relative timestamps instead of specific times
     ✓ No personal notes or symptom details
     ✓ Demo-clarified HIPAA disclaimer
     ✓ Sample data uses generic placeholders
     
     TEST MATRIX REQUIREMENTS:
     Browsers: iPhone Safari, Android Chrome, desktop Chrome/Edge
     A11y Tests: Reduced motion ON, Large text (125-150%), Dark mode ON, Private window
     Features: Profile switching, data archiving, quick actions, vitals tracking
     
     Caregiver Quick Actions (V2.7):
     - "Meds Done" - Instant medication logging
     - "Ask for vitals" - Send vitals reminder
     - "Note for tomorrow" - Schedule reminder notes
     - Auto-profile tagging on all entries
     
     Health Log UX (V2.6.5):
     - AI Summary at top with daily progress snapshot
     - Status tags on snapshot cards
     - Unified timeline with sticky date headers
     - Context-aware suggested actions
     - Conversational microcopy throughout
     
     Core Features:
     - Profile management with quick switcher
     - Medication tracking with reminders
     - Vitals monitoring (BP, glucose, weight, temp, O2)
     - Appointment scheduling
     - Symptoms & mood tracking
     - Analytics dashboard
     - Gamification (XP, badges, Health Buddy)
     - Zero-PHI local storage
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmberMate - Your Health Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Ember Sage Theme - Light Mode Base */
            --bg-primary: #F8F5F3;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #EFEBE9;
            --text-primary: #2D2623;
            --text-secondary: #5E534F;
            --text-tertiary: #8B7E79;
            --border-color: #D7CCC8;
            --shadow: rgba(62, 47, 70, 0.08);
            --shadow-lg: rgba(62, 47, 70, 0.12);
            
            /* Brand Colors - Ember Sage Palette */
            --primary: #CD876E;
            --primary-dark: #B57560;
            --secondary: #EFBE9E;
            --accent: #3E2F46;
            --success: #81A684;
            --success-soft: rgba(129, 166, 132, 0.12);
            --warning: #E6B88A;
            --warning-soft: rgba(230, 184, 138, 0.12);
            --danger: #C97064;
            --danger-soft: rgba(201, 112, 100, 0.12);
            --info: #8BA3B8;
            --info-soft: rgba(139, 163, 184, 0.12);
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Transitions - Standardized */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-standard: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Focus Ring - Standardized */
            --focus-ring: 0 0 0 3px rgba(205, 135, 110, 0.3);
            --focus-ring-offset: 2px;
        }

        /* Base Styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* Skip to Main Content Link - Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: var(--radius-md);
            z-index: 10000;
            font-weight: 600;
        }

        .skip-link:focus {
            top: 0.5rem;
            left: 0.5rem;
            outline: none;
            box-shadow: var(--focus-ring);
        }

        /* Typography - Standardized Hierarchy */
        h1 { font-size: 2rem; font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
        h2 { font-size: 1.5rem; font-weight: 600; line-height: 1.3; letter-spacing: -0.01em; }
        h3 { font-size: 1.25rem; font-weight: 600; line-height: 1.4; }
        h4 { font-size: 1.125rem; font-weight: 600; line-height: 1.4; }
        h5 { font-size: 1rem; font-weight: 600; line-height: 1.5; }
        h6 { font-size: 0.875rem; font-weight: 600; line-height: 1.5; }

        p { font-size: 1rem; line-height: 1.6; }
        small { font-size: 0.875rem; line-height: 1.5; }
        .text-xs { font-size: 0.75rem; line-height: 1.5; }

        /* Focus Ring Standardization */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        [tabindex]:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
            outline-offset: var(--focus-ring-offset);
        }

        button:focus:not(:focus-visible),
        a:focus:not(:focus-visible),
        input:focus:not(:focus-visible),
        select:focus:not(:focus-visible),
        textarea:focus:not(:focus-visible),
        [tabindex]:focus:not(:focus-visible) {
            outline: none;
            box-shadow: none;
        }

        /* Container & Layout */
        .app-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 0;
            box-sizing: border-box;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            box-sizing: border-box;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px var(--shadow));
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Profile Switcher */
        .profile-switcher {
            position: relative;
        }

        .role-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .role-indicator:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .role-indicator-icon {
            font-size: 1rem;
        }

        .role-indicator-text {
            white-space: nowrap;
        }

        .role-caretaker {
            background: rgba(205, 135, 110, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .role-patient {
            background: rgba(129, 166, 132, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .profile-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .profile-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 16rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 30px var(--shadow-lg);
            display: none;
            z-index: 200;
            max-height: 24rem;
            overflow-y: auto;
        }

        .profile-dropdown.show {
            display: block;
            animation: slideDown 0.15s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-0.5rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-dropdown-header h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .profile-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--border-color);
        }

        .profile-item:last-child {
            border-bottom: none;
        }

        .profile-item:hover {
            background: var(--bg-tertiary);
        }

        .profile-item.active {
            background: rgba(205, 135, 110, 0.08);
            border-left: 3px solid var(--primary);
        }

        .profile-item-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--info));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .profile-item-info {
            flex: 1;
            min-width: 0;
        }

        .profile-item-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
        }

        .profile-item-relation {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
        }

        .profile-item-badge {
            padding: 0.25rem 0.5rem;
            background: var(--success);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .add-profile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            color: var(--primary);
            font-weight: 600;
            border-top: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .add-profile-btn:hover {
            background: var(--bg-tertiary);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            padding: 0 1.5rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 0.875rem 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition-fast);
            white-space: nowrap;
            font-size: 0.9375rem;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-tab-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: var(--radius-full);
            font-weight: 700;
            min-width: 1.125rem;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.15s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(0.5rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition-fast);
            max-width: 100%;
            box-sizing: border-box;
        }

        .card:hover {
            border-color: rgba(205, 135, 110, 0.3);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Buttons - Standardized */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            border: none;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            line-height: 1.5;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(205, 135, 110, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-primary);
            border-color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #5ab86e;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #e6005f;
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
        }

        /* Form Elements - Standardized */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: var(--transition-fast);
        }

        .form-input:hover,
        .form-select:hover,
        .form-textarea:hover {
            border-color: rgba(205, 135, 110, 0.5);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 6rem;
        }

        /* Modal - Standardized */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.15s ease;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 100%;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg);
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(2rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            font-size: 1.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Onboarding Modal */
        #onboardingModal[style*="display: flex"] {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        #onboardingModal[style*="display: none"] {
            display: none !important;
        }

        #onboardingModal .modal-content {
            animation: slideUp 0.3s ease;
        }

        .onboarding-step .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 10px 30px var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            pointer-events: auto;
            animation: slideInRight 0.2s ease;
            position: relative;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(2rem);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.removing {
            animation: slideOutRight 0.2s ease forwards;
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(2rem);
            }
        }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9375rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--danger);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-info {
            border-left: 4px solid var(--info);
        }

        .toast-close {
            background: transparent;
            border: none;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            color: var(--text-tertiary);
            padding: 0.25rem;
            border-radius: 9999px;
            transition: var(--transition-fast);
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: rgba(0, 0, 0, 0.04);
            color: var(--text-primary);
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--bg-secondary) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state-message {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-profile-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(205, 135, 110, 0.08);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .form-profile-indicator strong {
            color: var(--primary);
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            /* Force mobile-friendly widths */
            .app-container,
            .header-content,
            .main-content,
            .card,
            .section,
            .panel {
                max-width: 100%;
                width: 100%;
            }

            /* Stack grids on mobile */
            .snapshot-grid,
            .quick-actions-grid,
            .analytics-grid,
            .achievement-grid,
            .glance-strip,
            .action-chips {
                display: block;
            }

            .snapshot-grid > *,
            .quick-actions-grid > *,
            .analytics-grid > *,
            .achievement-grid > *,
            .glance-strip > *,
            .action-chips > * {
                width: 100%;
                margin-bottom: 0.75rem;
            }

            /* Ensure images/charts stay within viewport */
            img,
            video,
            canvas,
            .chart {
                max-width: 100%;
                height: auto;
                display: block;
            }

            /* Prevent horizontal overflow */
            body,
            html {
                overflow-x: hidden;
                word-wrap: break-word;
            }

            h1 { font-size: 1.75rem; }
            h2 { font-size: 1.375rem; }
            h3 { font-size: 1.125rem; }
            
            .header-content {
                padding: 1rem;
                gap: 0.75rem;
                flex-direction: column;
                align-items: stretch;
                justify-content: center;
            }

            .header-content > div {
                width: 100%;
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            #modeHomeBtn {
                width: 100%;
                justify-content: center;
            }

            .logo-text {
                font-size: 1.2rem;
            }

            .role-indicator,
            .profile-btn {
                flex: 1 1 48%;
                justify-content: center;
                padding: 0.5rem 0.75rem;
            }

            .role-indicator {
                font-size: 0.8125rem;
            }

            .role-indicator-text span:first-child {
                display: none; /* Hide "Viewing as:" label on mobile */
            }

            .profile-btn-text {
                display: none;
            }

            .nav-tabs {
                padding: 0 1rem;
            }

            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .main-content {
                padding: 0.75rem;
            }

            .card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .ai-summary-section,
            .caregiver-quick-actions,
            .timeline-section,
            .suggested-actions {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .snapshot-card {
                padding: 1rem;
            }

            .timeline-header {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .timeline-entry {
                padding: 0.75rem 0.75rem 0.75rem 1rem;
                margin-bottom: 0.5rem;
            }

            .modal-content {
                margin: 0;
                border-radius: var(--radius-lg);
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 1rem;
            }

            .btn {
                width: 100%;
            }

            .modal-footer {
                flex-direction: column-reverse;
            }

            .modal-footer .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header {
                position: fixed;
                width: 100%;
                z-index: 1000;
            }

            .main-content {
                padding-top: 4.5rem; /* offset header height */
            }

            .toast {
                min-width: auto;
                max-width: calc(100vw - 2rem);
            }

            .toast-container {
                left: 1rem;
                right: 1rem;
            }
        }

        /* Print Styles */
        @media print {
            .header,
            .nav-tabs,
            .btn,
            .modal,
            .toast-container {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .card {
                border: 1px solid #ccc;
                break-inside: avoid;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #666;
                --text-secondary: #ccc;
            }

            .btn-primary {
                border: 2px solid var(--primary);
            }

            .form-input,
            .form-select,
            .form-textarea {
                border-width: 2px;
            }
        }

        /* Dark Mode (Already default, but explicitly defined) */
        @media (prefers-color-scheme: dark) {
            /* Colors already optimized for dark mode */
        }

        /* Large Text Support (125-150% zoom) */
        @media (min-resolution: 1.25dppx) and (max-resolution: 1.5dppx) {
            body {
                /* Browser handles text scaling, just ensure containers adapt */
                overflow-wrap: break-word;
                word-wrap: break-word;
            }

            .card,
            .modal-content,
            .ai-summary-section {
                max-width: 100%;
            }

            .btn {
                white-space: normal;
                min-height: 2.75rem;
            }

            .nav-tab {
                min-height: 3rem;
            }
        }

        /* ===== TAB-SPECIFIC STYLES ===== */

        /* Health Log Tab */
        .ai-summary-section {
            background: linear-gradient(135deg, rgba(205, 135, 110, 0.08), rgba(239, 190, 158, 0.08));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .ai-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .ai-summary-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .ai-summary-content {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .glance-strip {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .glance-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .glance-icon {
            font-size: 1.25rem;
        }

        .glance-label {
            color: var(--text-tertiary);
            margin-right: 0.25rem;
        }

        .glance-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .action-chips {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .action-chip {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .action-chip:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(205, 135, 110, 0.3);
        }

        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .snapshot-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .snapshot-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .snapshot-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .snapshot-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(205, 135, 110, 0.1);
        }

        .snapshot-status {
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-complete {
            background: var(--success-soft);
            color: var(--success);
        }

        .status-incomplete {
            background: var(--warning-soft);
            color: var(--warning);
        }

        .status-missing {
            background: var(--danger-soft);
            color: var(--danger);
        }

        .snapshot-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .snapshot-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .snapshot-subtitle {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
        }

        .timeline-section {
            margin-bottom: 1.5rem;
            overflow-x: auto;
            max-width: 100vw;
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }

        .timeline-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .timeline-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success-soft);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            color: var(--success);
        }

        .timeline-controls-wrapper {
            margin-bottom: 1rem;
        }

        .timeline-range {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .range-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .range-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .range-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .timeline-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .timeline-date-group {
            margin-bottom: 2rem;
        }

        .timeline-date-header {
            position: sticky;
            top: 5rem;
            background: var(--bg-primary);
            padding: 0.75rem 0;
            margin-bottom: 1rem;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }

        .timeline-date-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeline-entry {
            position: relative;
            padding: 1rem 1rem 1rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .timeline-entry:hover {
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .timeline-entry.vitals { border-left-color: var(--info); }
        .timeline-entry.medication { border-left-color: var(--success); }
        .timeline-entry.symptom { border-left-color: var(--warning); }
        .timeline-entry.symptoms { border-left-color: var(--warning); }
        .timeline-entry.appointment { border-left-color: var(--secondary); }
        .timeline-entry.appointments { border-left-color: var(--secondary); }
        .timeline-entry.glucose { border-left-color: #e91e63; }
        .timeline-entry.weight { border-left-color: #9c27b0; }
        .timeline-entry.mood { border-left-color: #ff9800; }
        .timeline-entry.note { border-left-color: var(--text-tertiary); }

        .timeline-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .timeline-entry-type {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .timeline-entry-time {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
        }

        .timeline-entry-content {
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .timeline-entry-note {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .timeline-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .timeline-empty p {
            margin: 0.5rem 0;
        }

        .timeline-empty p:first-child {
            font-weight: 600;
            color: var(--text-primary);
        }

        .suggested-actions {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .suggested-actions-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .suggested-actions-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .suggested-actions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .suggested-action-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
        }

        .suggested-action-item:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .suggested-action-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .suggested-action-icon {
            font-size: 1.5rem;
        }

        .suggested-action-text {
            flex: 1;
        }

        .suggested-action-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .suggested-action-subtitle {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
        }

        .suggested-action-btn {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .suggested-action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Caregiver Quick Actions (V2.7) */
        .caregiver-quick-actions {
            background: linear-gradient(135deg, rgba(239, 190, 158, 0.08), rgba(205, 135, 110, 0.08));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .quick-actions-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .quick-actions-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .quick-actions-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .quick-action-context {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0.5rem 0 1rem;
            font-weight: 500;
        }

        .quick-action-context span {
            color: var(--primary);
            font-weight: 600;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr));
            gap: 1rem;
        }

        .quick-action-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: center;
        }

        .quick-action-card:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(205, 135, 110, 0.25);
        }

        .quick-action-card:hover .quick-action-icon,
        .quick-action-card:hover .quick-action-title,
        .quick-action-card:hover .quick-action-description {
            color: white;
        }

        .quick-action-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            transition: var(--transition-fast);
        }

        .quick-action-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            transition: var(--transition-fast);
        }

        .quick-action-description {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }

        /* Medications Tab */
        .med-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .med-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: var(--transition-fast);
        }

        .med-card:hover {
            border-color: var(--success);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .med-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .med-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .med-dosage {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .med-status {
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .med-status.active {
            background: var(--success-soft);
            color: var(--success);
        }

        .med-status.paused {
            background: var(--warning-soft);
            color: var(--warning);
        }

        .med-schedule {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .med-time-chip {
            padding: 0.375rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            color: var(--text-primary);
        }

        .med-time-chip.taken {
            background: var(--success-soft);
            border-color: var(--success);
            color: var(--success);
        }

        .med-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .med-header {
            margin-bottom: 0.75rem;
        }

        .med-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .med-frequency,
        .med-times {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .med-icon {
            font-size: 1rem;
        }

        .med-notes {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            font-style: italic;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .med-action-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .med-action-btn:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
            transform: translateY(-2px);
        }

        /* Analytics Tab */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(320px, 100%), 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: var(--transition-fast);
        }

        .stat-card:hover {
            border-color: rgba(205, 135, 110, 0.5);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(205, 135, 110, 0.1);
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .stat-trend.positive {
            color: var(--success);
        }

        .stat-trend.negative {
            color: var(--danger);
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-control-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .chart-control-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .chart-control-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Gamification */
        .xp-bar-container {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .xp-level {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .xp-level-badge {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .xp-level-text {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .xp-title {
            font-size: 0.875rem;
            color: var(--secondary);
            font-weight: 600;
        }

        .xp-progress-bar {
            height: 2rem;
            background: var(--bg-primary);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .xp-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }

        .xp-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(140px, 100%), 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .achievement-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            text-align: center;
            transition: var(--transition-fast);
        }

        .achievement-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px var(--shadow);
        }

        .achievement-card.unlocked {
            border-color: var(--secondary);
            background: rgba(239, 190, 158, 0.1);
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .achievement-description {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .health-buddy-card {
            background: linear-gradient(135deg, rgba(205, 135, 110, 0.08), rgba(239, 190, 158, 0.08));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .health-buddy-avatar {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .health-buddy-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .health-buddy-message {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            font-style: italic;
            max-width: 400px;
            margin: 0 auto 1rem;
        }

        .health-buddy-mood-selector {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .health-buddy-mood-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .health-buddy-mood-btn:hover {
            transform: scale(1.15);
            border-color: var(--primary);
        }

        .health-buddy-mood-btn.active {
            border-color: var(--secondary);
            background: rgba(239, 190, 158, 0.15);
        }

        /* HIPAA Disclaimer */
        .hipaa-disclaimer {
            background: var(--warning-soft);
            border: 1px solid rgba(230, 184, 138, 0.3);
            border-radius: var(--radius-md);
            padding: 0.875rem 1.25rem;
            margin: 1.5rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .hipaa-icon {
            font-size: 1.25rem;
            color: var(--warning);
            flex-shrink: 0;
        }

        .hipaa-content {
            flex: 1;
        }

        .hipaa-title {
            font-weight: 600;
            color: var(--warning);
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
        }

        .hipaa-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }

        .hidden { display: none; }
        .block { display: block; }
        .inline-block { display: inline-block; }

        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <!-- Skip to Main Content Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer" role="alert" aria-live="polite" aria-atomic="true"></div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="header" role="banner">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo" role="img" aria-label="EmberMate Logo">🔥</div>
                    <div class="logo-text">EmberMate</div>
                </div>

                <!-- Role Toggle & Profile Switcher -->
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <!-- Mode-Aware Home Button -->
                    <button class="btn btn-secondary" 
                            id="modeHomeBtn"
                            onclick="goToModeHome()"
                            style="padding: 0.5rem 1rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;"
                            aria-label="Go to mode-specific home view">
                        <span id="modeHomeIcon">🏥</span>
                        <span id="modeHomeBtnText">Caregiver Home</span>
                    </button>

                    <div class="role-indicator role-caretaker" id="roleIndicator" 
                         onclick="toggleRole()"
                         role="button"
                         tabindex="0"
                         aria-label="Switch between patient and caretaker view">
                        <span class="role-indicator-icon" id="roleIndicatorIcon">👥</span>
                        <span class="role-indicator-text">
                            <span style="font-size: 0.75rem; opacity: 0.7;">Viewing as:</span>
                            <strong id="roleIndicatorText" style="margin-left: 0.25rem;">Caretaker</strong>
                        </span>
                    </div>

                    <div class="profile-switcher">
                        <button class="profile-btn" id="profileBtn" 
                                aria-label="Switch profile"
                                aria-haspopup="true"
                                aria-expanded="false">
                            <div class="profile-avatar" id="currentProfileAvatar">👤</div>
                            <span class="profile-btn-text" id="currentProfileName">Demo User</span>
                            <span>▼</span>
                        </button>

                        <div class="profile-dropdown" id="profileDropdown" role="menu">
                            <div class="profile-dropdown-header">
                                <h4>Switch Profile</h4>
                            </div>
                            <div id="profileList" role="group">
                                <!-- Profiles populated by JS -->
                            </div>
                            <div class="add-profile-btn" id="addProfileBtn" role="menuitem" tabindex="0">
                                <span>➕</span>
                                <span>Add New Profile</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs" role="tablist" aria-label="Main navigation">
            <div class="nav-tab active" data-tab="healthLog" data-test="nav-health-log" role="tab" aria-selected="true" aria-controls="healthLog-panel" tabindex="0">
                📋 Health Log
            </div>
            <div class="nav-tab" data-tab="medications" data-test="nav-medications" role="tab" aria-selected="false" aria-controls="medications-panel" tabindex="-1">
                💊 Medications
                <span class="nav-tab-badge" id="medBadge">2</span>
            </div>
            <div class="nav-tab" data-tab="appointments" data-test="nav-appointments" role="tab" aria-selected="false" aria-controls="appointments-panel" tabindex="-1">
                📅 Appointments
            </div>
            <div class="nav-tab" data-tab="analytics" data-test="nav-analytics" role="tab" aria-selected="false" aria-controls="analytics-panel" tabindex="-1">
                📊 Analytics
            </div>
            <div class="nav-tab" data-tab="profile" data-test="nav-profile" role="tab" aria-selected="false" aria-controls="profile-panel" tabindex="-1">
                👤 Profile
            </div>
            <div class="nav-tab" data-tab="debug" data-test="nav-debug" role="tab" aria-selected="false" aria-controls="debug-panel" tabindex="-1" style="display: none;" id="debugNavTab">
                🔧 Debug/QA
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="main-content" role="main">
            <!-- Health Log Tab -->
            <div class="tab-content active" id="healthLog-panel" role="tabpanel" aria-labelledby="healthLog">
                <!-- AI Summary Section -->
                <section class="ai-summary-section" aria-label="Daily summary">
                    <div class="ai-summary-header">
                        <div class="ai-summary-title">
                            <span>✨</span>
                            <span>Your Day at a Glance</span>
                        </div>
                    </div>

                    <p class="ai-summary-content">
                        <span id="aiSummaryText">
                            <!-- Dynamic summary based on role -->
                        </span>
                    </p>

                    <div class="glance-strip">
                        <div class="glance-item">
                            <span class="glance-icon">💊</span>
                            <span class="glance-label">Meds:</span>
                            <span class="glance-value">Most logged</span>
                        </div>
                        <div class="glance-item">
                            <span class="glance-icon">🩺</span>
                            <span class="glance-label">BP:</span>
                            <span class="glance-value">On target</span>
                        </div>
                        <div class="glance-item">
                            <span class="glance-icon">🎯</span>
                            <span class="glance-label">Week:</span>
                            <span class="glance-value">Active</span>
                        </div>
                    </div>

                    <div class="action-chips">
                        <button class="action-chip" onclick="showQuickAddModal('vitals')" 
                                aria-label="Add vital reading">
                            <span>🩺</span>
                            <span>Add Reading</span>
                        </button>
                        <button class="action-chip" onclick="switchTab('analytics')"
                                aria-label="View health trends">
                            <span>📊</span>
                            <span>View Trends</span>
                        </button>
                        <button class="action-chip" onclick="showQuickAddModal('mood')"
                                aria-label="Log mood">
                            <span>😊</span>
                            <span>Log Mood</span>
                        </button>
                    </div>
                </section>

                <!-- Caregiver Quick Actions (V2.7) -->
                <section class="caregiver-quick-actions" id="caregiverQuickActions" aria-label="Caregiver quick actions">
                    <div class="quick-actions-header">
                        <span>🏥</span>
                        <h2 class="quick-actions-title">Caregiver Quick Actions</h2>
                    </div>
                    <p class="quick-actions-subtitle">
                        Everyday caregiving made simple — 2-3 taps instead of multiple forms
                    </p>
                    <p class="quick-action-context">For: <span id="quick-action-profile-name">-</span></p>

                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="logAllMedsDone()" 
                             role="button" tabindex="0"
                             aria-label="Log all medications as taken"
                             data-test="quick-action-log-meds">
                            <div class="quick-action-icon">💊</div>
                            <div class="quick-action-title">Meds Done</div>
                            <p class="quick-action-description">Quick log: all meds taken today</p>
                        </div>

                        <div class="quick-action-card" onclick="showAskForVitalsModal()"
                             role="button" tabindex="0"
                             aria-label="Send vitals reminder"
                             data-test="quick-action-ask-vitals">
                            <div class="quick-action-icon">📲</div>
                            <div class="quick-action-title">Ask for Vitals</div>
                            <p class="quick-action-description">Gentle reminder to check readings</p>
                        </div>

                        <div class="quick-action-card" onclick="showAddNoteForTomorrowModal()"
                             role="button" tabindex="0"
                             aria-label="Add reminder note"
                             data-test="quick-action-note-tomorrow">
                            <div class="quick-action-icon">📝</div>
                            <div class="quick-action-title">Note for Tomorrow</div>
                            <p class="quick-action-description">Set a reminder for later</p>
                        </div>
                    </div>
                </section>

                <!-- Snapshot Cards -->
                <section aria-label="Health snapshot">
                    <div class="snapshot-grid">
                        <div class="snapshot-card" onclick="showQuickAddModal('vitals')">
                            <div class="snapshot-header">
                                <div class="snapshot-icon">🩺</div>
                                <span class="snapshot-status status-complete">Up to date</span>
                            </div>
                            <div class="snapshot-title">Blood Pressure</div>
                            <div class="snapshot-value">Within target</div>
                            <div class="snapshot-subtitle">Looking good</div>
                        </div>

                        <div class="snapshot-card" onclick="showQuickAddModal('glucose')">
                            <div class="snapshot-header">
                                <div class="snapshot-icon">🩸</div>
                                <span class="snapshot-status status-complete">Normal range</span>
                            </div>
                            <div class="snapshot-title">Blood Sugar</div>
                            <div class="snapshot-value">Normal range</div>
                            <div class="snapshot-subtitle">Recently checked</div>
                        </div>

                        <div class="snapshot-card" onclick="showQuickAddModal('medication')">
                            <div class="snapshot-header">
                                <div class="snapshot-icon">💊</div>
                                <span class="snapshot-status status-incomplete">1 remaining</span>
                            </div>
                            <div class="snapshot-title">Medications</div>
                            <div class="snapshot-value">Most taken</div>
                            <div class="snapshot-subtitle">Next dose later today</div>
                        </div>

                        <div class="snapshot-card" onclick="showQuickAddModal('weight')">
                            <div class="snapshot-header">
                                <div class="snapshot-icon">⚖️</div>
                                <span class="snapshot-status status-missing">Check today</span>
                            </div>
                            <div class="snapshot-title">Weight</div>
                            <div class="snapshot-value">--</div>
                            <div class="snapshot-subtitle">Check when ready</div>
                        </div>
                    </div>
                </section>

                <!-- Unified Timeline -->
                <section class="timeline-section" aria-label="Health timeline">
                    <div class="timeline-header">
                        <h2 class="timeline-title">Your Health Story</h2>
                        <div class="timeline-progress">
                            <span>✅</span>
                            <span>You're on track! Regular updates this week</span>
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="timeline-controls-wrapper">
                        <div class="timeline-range" role="group" aria-label="Select date range">
                            <button class="range-btn active" data-range="today">Today</button>
                            <button class="range-btn" data-range="week">This Week</button>
                            <button class="range-btn" data-range="all">All</button>
                        </div>
                        <div class="timeline-filter" role="group" aria-label="Filter timeline">
                            <button class="filter-chip active" data-filter="all">All</button>
                            <button class="filter-chip" data-filter="vitals">🩺 Vitals</button>
                            <button class="filter-chip" data-filter="medication">💊 Meds</button>
                            <button class="filter-chip" data-filter="symptoms">🤒 Symptoms</button>
                            <button class="filter-chip" data-filter="appointments">📅 Appointments</button>
                        </div>
                    </div>

                    <!-- Timeline Entries -->
                    <div id="timelineContainer">
                        <!-- Today -->
                        <div class="timeline-date-group">
                            <div class="timeline-date-header">
                                <h3>Today</h3>
                            </div>

                            <article class="timeline-entry vitals">
                                <div class="timeline-entry-header">
                                    <span class="timeline-entry-type">Vitals</span>
                                    <span class="timeline-entry-time">Earlier today</span>
                                </div>
                                <div class="timeline-entry-content">
                                    Blood pressure recorded and within target range
                                </div>
                            </article>

                            <article class="timeline-entry medication">
                                <div class="timeline-entry-header">
                                    <span class="timeline-entry-type">Medication</span>
                                    <span class="timeline-entry-time">Morning</span>
                                </div>
                                <div class="timeline-entry-content">
                                    Medication A logged as taken
                                </div>
                            </article>

                            <article class="timeline-entry vitals">
                                <div class="timeline-entry-header">
                                    <span class="timeline-entry-type">Vitals</span>
                                    <span class="timeline-entry-time">Morning</span>
                                </div>
                                <div class="timeline-entry-content">
                                    Blood sugar checked — within normal range
                                </div>
                            </article>
                        </div>

                        <!-- Yesterday -->
                        <div class="timeline-date-group">
                            <div class="timeline-date-header">
                                <h3>Yesterday</h3>
                            </div>

                            <article class="timeline-entry medication">
                                <div class="timeline-entry-header">
                                    <span class="timeline-entry-type">Medication</span>
                                    <span class="timeline-entry-time">Evening</span>
                                </div>
                                <div class="timeline-entry-content">
                                    Medication B logged as taken
                                </div>
                            </article>

                            <article class="timeline-entry symptom">
                                <div class="timeline-entry-header">
                                    <span class="timeline-entry-type">Symptom</span>
                                    <span class="timeline-entry-time">Afternoon</span>
                                </div>
                                <div class="timeline-entry-content">
                                    Symptom noted and tracked
                                </div>
                            </article>
                        </div>

                        <!-- Empty State (shown when no entries) -->
                        <div class="empty-state hidden" id="timelineEmptyState">
                            <div class="empty-state-icon">📝</div>
                            <div class="empty-state-title">No entries yet</div>
                            <p class="empty-state-message">
                                Start tracking your health journey by adding your first entry above
                            </p>
                            <button class="btn btn-primary" onclick="showQuickAddModal('vitals')">
                                Log your first health update
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Suggested Next Steps -->
                <section class="suggested-actions" aria-label="Suggested actions">
                    <div class="suggested-actions-header">
                        <span>💡</span>
                        <h2 class="suggested-actions-title">Suggested Next Steps</h2>
                    </div>

                    <div class="suggested-actions-list">
                        <div class="suggested-action-item">
                            <div class="suggested-action-content">
                                <span class="suggested-action-icon">💊</span>
                                <div class="suggested-action-text">
                                    <div class="suggested-action-title">Next Medication</div>
                                    <div class="suggested-action-subtitle">Next dose due soon</div>
                                </div>
                            </div>
                            <button class="suggested-action-btn" onclick="logMedication('medication')">
                                Log Now
                            </button>
                        </div>

                        <div class="suggested-action-item">
                            <div class="suggested-action-content">
                                <span class="suggested-action-icon">⚖️</span>
                                <div class="suggested-action-text">
                                    <div class="suggested-action-title">Check Your Weight</div>
                                    <div class="suggested-action-subtitle">Ready for next check-in</div>
                                </div>
                            </div>
                            <button class="suggested-action-btn" onclick="showQuickAddModal('weight')">
                                Add Weight
                            </button>
                        </div>

                        <div class="suggested-action-item">
                            <div class="suggested-action-content">
                                <span class="suggested-action-icon">😊</span>
                                <div class="suggested-action-text">
                                    <div class="suggested-action-title">How Are You Feeling?</div>
                                    <div class="suggested-action-subtitle">Quick mood check-in</div>
                                </div>
                            </div>
                            <button class="suggested-action-btn" onclick="showQuickAddModal('mood')">
                                Log Mood
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Medications Tab -->
            <div class="tab-content" id="medications-panel" role="tabpanel" aria-labelledby="medications">
                <div class="card-header">
                    <h2 class="card-title">Your Medications</h2>
                    <button class="btn btn-primary" onclick="showAddMedicationModal()">
                        ➕ Add Medication
                    </button>
                </div>

                <div class="med-grid" id="medicationsContainer">
                    <!-- Medications populated by JS -->
                    <div class="empty-state">
                        <div class="empty-state-icon">💊</div>
                        <div class="empty-state-title">No medications yet</div>
                        <p class="empty-state-message">
                            Add your first medication to start tracking
                        </p>
                        <button class="btn btn-primary" onclick="showAddMedicationModal()">
                            Add First Medication
                        </button>
                    </div>
                </div>
            </div>

            <!-- Appointments Tab -->
            <div class="tab-content" id="appointments-panel" role="tabpanel" aria-labelledby="appointments">
                <div class="card-header">
                    <h2 class="card-title">Upcoming Appointments</h2>
                    <button class="btn btn-primary" onclick="showAddAppointmentModal()">
                        ➕ Schedule Appointment
                    </button>
                </div>

                <div id="appointmentsContainer">
                    <!-- Appointments populated by JS -->
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <div class="empty-state-title">No appointments scheduled</div>
                        <p class="empty-state-message">
                            Schedule your first appointment to stay on track
                        </p>
                        <button class="btn btn-primary" onclick="showAddAppointmentModal()">
                            Schedule First Appointment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics-panel" role="tabpanel" aria-labelledby="analytics">
                <div class="card-header">
                    <h2 class="card-title">Health Analytics</h2>
                    <div class="chart-controls">
                        <button class="chart-control-btn active" data-period="7d">7 Days</button>
                        <button class="chart-control-btn" data-period="30d">30 Days</button>
                        <button class="chart-control-btn" data-period="90d">90 Days</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">💊</div>
                            <div class="stat-info">
                                <div class="stat-label">Medication Adherence</div>
                                <div class="stat-value">Excellent</div>
                            </div>
                        </div>
                        <div class="stat-trend positive">
                            <span>✓</span>
                            <span>Consistent tracking</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">🩺</div>
                            <div class="stat-info">
                                <div class="stat-label">Avg Blood Pressure</div>
                                <div class="stat-value">On target</div>
                            </div>
                        </div>
                        <div class="stat-trend positive">
                            <span>✓</span>
                            <span>Within target range</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">📊</div>
                            <div class="stat-info">
                                <div class="stat-label">Health Entries</div>
                                <div class="stat-value">Active</div>
                            </div>
                        </div>
                        <div class="stat-trend positive">
                            <span>✓</span>
                            <span>Regular logging</span>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Blood Pressure Trend</h3>
                    </div>
                    <canvas id="bpChart" aria-label="Blood pressure trend chart"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Blood Sugar Trend</h3>
                    </div>
                    <canvas id="bsChart" aria-label="Blood sugar trend chart"></canvas>
                </div>

                <!-- Vitals History Table (UC9) -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Recent Vitals</h3>
                    </div>
                    <div id="vitalsTable" style="overflow-x: auto;">
                        <!-- Table populated dynamically -->
                    </div>
                </div>

                <!-- Gamification Section -->
                <div class="xp-bar-container">
                    <div class="xp-header">
                        <div class="xp-level">
                            <div class="xp-level-badge" aria-label="Level 12">12</div>
                            <span class="xp-level-text">Guardian Level 12</span>
                        </div>
                        <span class="xp-title">Demo Progress</span>
                    </div>

                    <div class="xp-progress-bar" role="progressbar" 
                         aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"
                         aria-label="Experience progress: 65 percent">
                        <div class="xp-progress-fill" style="width: 65%">
                            Demo XP Display
                        </div>
                    </div>

                    <div class="xp-info">
                        <span>Keep tracking regularly!</span>
                        <span>🎯 Stay engaged</span>
                    </div>
                </div>

                <div class="health-buddy-card">
                    <div class="health-buddy-avatar">🐻</div>
                    <div class="health-buddy-name">Buddy the Health Bear</div>
                    <p class="health-buddy-message">
                        "Welcome! Regular tracking helps you stay on top of your health. 
                        How are you feeling today?"
                    </p>
                    <div class="health-buddy-mood-selector" role="group" aria-label="Select your mood">
                        <button class="health-buddy-mood-btn" onclick="logMood('great')" 
                                aria-label="Feeling great">😄</button>
                        <button class="health-buddy-mood-btn" onclick="logMood('good')"
                                aria-label="Feeling good">😊</button>
                        <button class="health-buddy-mood-btn" onclick="logMood('okay')"
                                aria-label="Feeling okay">😐</button>
                        <button class="health-buddy-mood-btn" onclick="logMood('tired')"
                                aria-label="Feeling tired">😴</button>
                        <button class="health-buddy-mood-btn" onclick="logMood('unwell')"
                                aria-label="Not feeling well">😷</button>
                    </div>
                </div>

                <h3 style="margin: 2rem 0 1rem;">Your Achievements</h3>
                <div class="achievement-grid">
                    <div class="achievement-card unlocked">
                        <div class="achievement-icon">🏆</div>
                        <div class="achievement-name">First Steps</div>
                        <p class="achievement-description">Created your first health entry</p>
                    </div>

                    <div class="achievement-card unlocked">
                        <div class="achievement-icon">🔥</div>
                        <div class="achievement-name">7-Day Streak</div>
                        <p class="achievement-description">Logged health data regularly</p>
                    </div>

                    <div class="achievement-card unlocked">
                        <div class="achievement-icon">💊</div>
                        <div class="achievement-name">Med Master</div>
                        <p class="achievement-description">Consistent medication tracking</p>
                    </div>

                    <div class="achievement-card locked">
                        <div class="achievement-icon">⭐</div>
                        <div class="achievement-name">30-Day Champion</div>
                        <p class="achievement-description">Maintain a 30-day logging streak</p>
                    </div>

                    <div class="achievement-card locked">
                        <div class="achievement-icon">🎯</div>
                        <div class="achievement-name">Target Achieved</div>
                        <p class="achievement-description">Consistent health tracking</p>
                    </div>

                    <div class="achievement-card locked">
                        <div class="achievement-icon">👨‍⚕️</div>
                        <div class="achievement-name">Health Advocate</div>
                        <p class="achievement-description">Attend medical appointments</p>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-content" id="profile-panel" role="tabpanel" aria-labelledby="profile">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Profile Settings</h2>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileNameInput">Name</label>
                        <input type="text" id="profileNameInput" class="form-input" 
                               placeholder="Enter name" value="Demo User">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileRelationInput">Relation</label>
                        <select id="profileRelationInput" class="form-select">
                            <option value="self">Self</option>
                            <option value="parent">Parent</option>
                            <option value="child">Child</option>
                            <option value="spouse">Spouse</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileDOBInput">Date of Birth</label>
                        <input type="date" id="profileDOBInput" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profileConditionsInput">Health Conditions</label>
                        <textarea id="profileConditionsInput" class="form-textarea" 
                                  placeholder="List any chronic conditions or health concerns"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="saveProfileSettings()">
                        Save Changes
                    </button>
                </div>

                <!-- HIPAA Disclaimer -->
                <div class="hipaa-disclaimer" role="note" aria-label="Privacy information">
                    <div class="hipaa-icon" aria-hidden="true">ℹ️</div>
                    <div class="hipaa-content">
                        <div class="hipaa-title">Demo Mode - Fictional Data Only</div>
                        <p class="hipaa-text">
                            This demonstration does not store or process Protected Health Information (PHI). 
                            All data shown are fictional examples and fully anonymized for demonstration purposes. 
                            EmberMate stores everything locally in your browser when used with real data. 
                            Always share important health updates with your doctor.
                        </p>
                    </div>
                </div>

                <!-- Personal Tracker Notice -->
                <div class="card" style="background: var(--warning-soft); border-left: 4px solid var(--warning);">
                    <div style="padding: 1rem;">
                        <div style="display: flex; gap: 0.75rem; align-items: start;">
                            <div style="font-size: 1.5rem;">⚠️</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                                    This is a personal tracker, not a clinical record
                                </div>
                                <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">
                                    EmberMate is for your personal use and wellness tracking. It is not HIPAA-compliant and should not be used as a medical record. 
                                    Always consult healthcare providers for medical decisions.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Data Management</h2>
                        <div style="font-size: 0.875rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                            EmberMate v<span id="appVersionDisplay">2.10.0</span>
                        </div>
                    </div>

                    <div id="archivedEntriesNotice" style="display: none; padding: 1rem; background: var(--info-soft, rgba(139, 163, 184, 0.12)); border-radius: var(--radius-md); margin-bottom: 1rem; color: var(--text-secondary);">
                        <strong>📦 Archive:</strong> <span id="archivedCount">0</span> older entries archived to keep the app fast.
                    </div>

                    <button class="btn btn-secondary mb-2" onclick="exportAllData()" data-test="btn-export-data">
                        📥 Export All Data
                    </button>

                    <button class="btn btn-secondary mb-2" onclick="importAllData()" data-test="btn-import-data">
                        📤 Import Backup
                    </button>

                    <button class="btn btn-secondary mb-2" onclick="importCSV()" data-test="btn-import-csv">
                        📋 Import from CSV
                    </button>

                    <button class="btn btn-danger" onclick="clearAllData()" data-test="btn-clear-data">
                        🗑️ Clear All Data
                    </button>

                    <div id="importExportStatus" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-tertiary); padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md); display: none;">
                        <!-- Status appears here after import/export -->
                    </div>
                </div>
            </div>

            <!-- Debug/QA Panel -->
            <div class="tab-content" id="debug-panel" role="tabpanel" aria-labelledby="debug" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🔧 Developer & QA Panel</h2>
                        <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                            Access via URL: Add <code>?debug=1</code> or press <kbd>Ctrl+Shift+D</kbd> (Cmd+Shift+D on Mac)
                        </p>
                    </div>

                    <!-- Test Matrix Requirements -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">📋 Test Matrix Requirements</h3>
                        
                        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                            <h4 style="font-weight: 600; margin-bottom: 0.75rem;">Browser Coverage</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-ios-safari"> iPhone Safari (iOS 15+)
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-android-chrome"> Android Chrome (v90+)
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-desktop-chrome"> Desktop Chrome/Chromium
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-desktop-edge"> Desktop Edge
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                            <h4 style="font-weight: 600; margin-bottom: 0.75rem;">Accessibility Tests</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-reduced-motion"> Reduced motion ON (prefers-reduced-motion)
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-large-text-125"> Large text 125% zoom
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-large-text-150"> Large text 150% zoom
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-dark-mode"> Dark mode ON
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-private-window"> Private/Incognito window
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: var(--radius-md);">
                            <h4 style="font-weight: 600; margin-bottom: 0.75rem;">Feature Tests</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-profile-switching"> Profile switching (multiple profiles)
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-data-archiving"> Data archiving (1000+ entries)
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-quick-actions"> Caregiver quick actions
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-vitals-tracking"> Vitals tracking (BP, glucose, weight, temp, O2)
                                    </label>
                                </li>
                                <li style="padding: 0.5rem 0;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="test-phi-guards"> PHI guards (warnings on sensitive data)
                                    </label>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- App State Inspector -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">🔍 Current App State</h3>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: 'Courier New', monospace; font-size: 0.875rem;">
                            <div><strong>Version:</strong> <span id="debug-version">-</span></div>
                            <div><strong>Current Profile:</strong> <span id="debug-profile">-</span></div>
                            <div><strong>Total Profiles:</strong> <span id="debug-profile-count">-</span></div>
                            <div><strong>View Mode:</strong> <span id="debug-role">-</span></div>
                            <div><strong>Total Entries:</strong> <span id="debug-entries">-</span></div>
                            <div><strong>Archived Entries:</strong> <span id="debug-archived">-</span></div>
                            <div><strong>Local Storage Used:</strong> <span id="debug-storage">-</span></div>
                            <div><strong>Last Updated:</strong> <span id="debug-last-update">-</span></div>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshDebugInfo()" style="margin-top: 1rem;">
                            🔄 Refresh State
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">⚡ Quick Dev Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button class="btn btn-secondary" onclick="seedDemoVitals()">
                                🩺 Seed Demo Vitals (UC9)
                            </button>
                            <button class="btn btn-secondary" onclick="addTestData()">
                                🧪 Add Test Data (50 entries)
                            </button>
                            <button class="btn btn-secondary" onclick="addMassData()">
                                📊 Add Mass Data (1000 entries)
                            </button>
                            <button class="btn btn-secondary" onclick="simulateArchive()">
                                📦 Trigger Archive
                            </button>
                            <button class="btn btn-secondary" onclick="testPHIWarnings()">
                                ⚠️ Test PHI Warnings
                            </button>
                            <button class="btn btn-secondary" onclick="window.location.reload()">
                                🔄 Hard Reload
                            </button>
                            <button class="btn btn-danger" onclick="localStorage.clear(); window.location.reload()">
                                💥 Nuke LocalStorage
                            </button>
                        </div>
                    </div>

                    <!-- Test Attributes Reference -->
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">📝 data-test Attributes</h3>
                        <details style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md);">
                            <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">View all test selectors</summary>
                            <pre style="font-size: 0.75rem; margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace;">
Navigation:
  data-test="nav-health-log"
  data-test="nav-medications"
  data-test="nav-appointments"
  data-test="nav-analytics"
  data-test="nav-profile"

Buttons:
  data-test="btn-export-data"
  data-test="btn-import-data"
  data-test="btn-import-csv"
  data-test="btn-clear-data"
  data-test="btn-add-quick-action"

Forms:
  data-test="input-profile-name"
  data-test="select-profile-relation"
  data-test="input-vitals-bp-sys"
  data-test="input-vitals-bp-dia"
                            </pre>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Quick Add Modal -->
    <div class="modal" id="quickAddModal" role="dialog" aria-labelledby="quickAddModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="quickAddModalTitle">Add Health Entry</h3>
                <button class="modal-close" onclick="closeModal('quickAddModal')" aria-label="Close modal">×</button>
            </div>
            <div class="modal-body" id="quickAddModalBody">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal" id="addProfileModal" role="dialog" aria-labelledby="addProfileModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="addProfileModalTitle">Add New Profile</h3>
                <button class="modal-close" onclick="closeModal('addProfileModal')" aria-label="Close modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="newProfileName">Name</label>
                    <input type="text" id="newProfileName" class="form-input" 
                           placeholder="Enter name" autofocus>
                </div>

                <div class="form-group">
                    <label class="form-label" for="newProfileRelation">Relation</label>
                    <select id="newProfileRelation" class="form-select">
                        <option value="self">Self</option>
                        <option value="parent">Parent</option>
                        <option value="child">Child</option>
                        <option value="spouse">Spouse</option>
                        <option value="grandparent">Grandparent</option>
                        <option value="sibling">Sibling</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addProfileModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createNewProfile()">
                    Create Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal" id="onboardingModal" role="dialog" aria-labelledby="onboardingModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <!-- Step 1: Role Selection -->
            <div id="onboardingStep1" class="onboarding-step">
                <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                    <h3 class="modal-title" id="onboardingModalTitle" style="text-align: center; width: 100%; font-size: 1.75rem;">Welcome to EmberMate 👋</h3>
                </div>
                <div class="modal-body" style="padding-top: 1rem;">
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem; font-size: 1.125rem;">
                        Let's get you started in just a few steps
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button class="btn" onclick="selectRole('patient')" style="padding: 1.5rem; font-size: 1.125rem; text-align: left; display: flex; align-items: center; gap: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s;">
                            <span style="font-size: 2rem;">🏥</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">I'm managing my own health</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Track your personal health journey</div>
                            </div>
                        </button>
                        <button class="btn" onclick="selectRole('caretaker')" style="padding: 1.5rem; font-size: 1.125rem; text-align: left; display: flex; align-items: center; gap: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s;">
                            <span style="font-size: 2rem;">❤️</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">I care for someone</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Track health for family or friends</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Data Import Options -->
            <div id="onboardingStep2" class="onboarding-step" style="display: none;">
                <div class="modal-header">
                    <h3 class="modal-title" style="text-align: center; width: 100%;">Start fresh or import data?</h3>
                </div>
                <div class="modal-body">
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
                        Choose how you'd like to begin tracking health data
                    </p>
                    
                    <div style="background: #FFF3CD; border: 1px solid #FFE69C; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <span style="font-size: 1.25rem;">⚠️</span>
                            <div style="font-size: 0.875rem; color: #856404;">
                                <strong>Privacy Notice:</strong> EmberMate stores all data locally on your device only. 
                                We're not HIPAA compliant. Don't import official medical records from MyChart or similar systems.
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button class="btn" onclick="selectDataImport('fresh')" 
                                style="padding: 1.5rem; font-size: 1.125rem; text-align: left; display: flex; align-items: center; gap: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s;">
                            <span style="font-size: 2rem;">✨</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Start fresh</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Begin tracking from today</div>
                            </div>
                        </button>
                        <button class="btn" onclick="selectDataImport('previous')" 
                                style="padding: 1.5rem; font-size: 1.125rem; text-align: left; display: flex; align-items: center; gap: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s;">
                            <span style="font-size: 2rem;">📥</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Import from backup</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Restore previous EmberMate data</div>
                            </div>
                        </button>
                        <button class="btn" onclick="selectDataImport('manual')" 
                                style="padding: 1.5rem; font-size: 1.125rem; text-align: left; display: flex; align-items: center; gap: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all 0.2s;">
                            <span style="font-size: 2rem;">✏️</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">I'll enter manually</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Type in existing data yourself</div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="onboardingBack(1)">Back</button>
                </div>
            </div>

            <!-- Step 3: Create Profile -->
            <div id="onboardingStep3" class="onboarding-step" style="display: none;">
                <div class="modal-header">
                    <h3 class="modal-title" style="text-align: center; width: 100%;">Create your first profile</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" for="onboardingName">Name</label>
                        <input type="text" id="onboardingName" class="form-input" placeholder="Enter name" autofocus>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="onboardingRelation">Relation</label>
                        <select id="onboardingRelation" class="form-select">
                            <option value="self">Self</option>
                            <option value="parent">Parent</option>
                            <option value="child">Child</option>
                            <option value="spouse">Spouse</option>
                            <option value="grandparent">Grandparent</option>
                            <option value="sibling">Sibling</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="onboardingBack(2)">Back</button>
                    <button class="btn btn-primary" onclick="onboardingCreateProfile()">Continue</button>
                </div>
            </div>

            <!-- Step 4: Sample Entries -->
            <div id="onboardingStep4" class="onboarding-step" style="display: none;">
                <div class="modal-header">
                    <h3 class="modal-title" style="text-align: center; width: 100%;">
                        <span id="onboardingStep4Title">Here's what you can track</span>
                    </h3>
                </div>
                <div class="modal-body">
                    <p id="onboardingStep4Subtitle" style="text-align: center; color: var(--text-secondary); margin-bottom: 1.5rem;">
                        EmberMate helps you log health updates easily
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); display: flex; align-items: center; gap: 1rem;">
                            <span style="font-size: 1.5rem;">💊</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Medications</div>
                                <div id="onboardingMedsDesc" style="font-size: 0.875rem; color: var(--text-secondary);">Quick "Mark as done" for daily meds</div>
                            </div>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); display: flex; align-items: center; gap: 1rem;">
                            <span style="font-size: 1.5rem;">❤️</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Vitals</div>
                                <div id="onboardingVitalsDesc" style="font-size: 0.875rem; color: var(--text-secondary);">Blood pressure, glucose, weight, and more</div>
                            </div>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); display: flex; align-items: center; gap: 1rem;">
                            <span style="font-size: 1.5rem;">😊</span>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Mood & Symptoms</div>
                                <div id="onboardingMoodDesc" style="font-size: 0.875rem; color: var(--text-secondary);">Track how you're feeling each day</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="finishOnboarding()" style="width: 100%;">Your app is ready!</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        const APP_VERSION = '2.14';
        
        const APP_CONFIG = {
            MAX_ENTRIES_PER_PROFILE: 1000,
            ARCHIVE_WARNING_THRESHOLD: 950,
            CLEANUP_BATCH_SIZE: 100
        };

        const AppState = {
            currentProfile: null,
            profiles: [],
            currentTab: 'healthLog',
            previousTab: null, // UC10: Track previous tab for debug panel hide
            healthEntries: [],
            medications: [
                {
                    id: 'med-demo-1',
                    name: 'Medication A',
                    dosage: '10mg',
                    frequency: 'Daily',
                    times: ['08:00', '20:00'],
                    profileId: null, // Set when profile loads
                    notes: 'Take with food'
                },
                {
                    id: 'med-demo-2',
                    name: 'Medication B',
                    dosage: '5mg',
                    frequency: 'Daily',
                    times: ['09:00'],
                    profileId: null, // Set when profile loads
                    notes: 'Take in morning'
                }
            ],
            appointments: [],
            archivedEntriesCount: 0,
            timelineRange: 'today',
            timelineFilter: 'all',
            charts: {} // Store chart instances
        };

        // ===== VERSION MANAGEMENT & MIGRATIONS =====
        function checkVersionAndMigrate() {
            const savedVersion = localStorage.getItem('embermate_version');
            
            // First time user or unversioned data
            if (!savedVersion) {
                console.log('Initializing version tracking');
                localStorage.setItem('embermate_version', APP_VERSION);
                return;
            }
            
            // Version has changed - run migrations
            if (savedVersion !== APP_VERSION) {
                console.log(`Migrating from ${savedVersion} to ${APP_VERSION}`);
                runMigrations(savedVersion, APP_VERSION);
                localStorage.setItem('embermate_version', APP_VERSION);
            }
        }

        function runMigrations(fromVersion, toVersion) {
            // Example migration logic - expand as needed
            // Compare versions and run necessary migrations
            
            // Migration example: if upgrading from pre-2.10 to 2.10+
            if (compareVersions(fromVersion, '2.10.0') < 0) {
                console.log('Running migration: Adding version metadata to profiles');
                const profiles = JSON.parse(localStorage.getItem('embermate_profiles') || '[]');
                
                // Ensure all profiles have required fields
                profiles.forEach(profile => {
                    if (!profile.createdAt) {
                        profile.createdAt = new Date().toISOString();
                    }
                    if (!profile.role) {
                        profile.role = 'patient';
                    }
                });
                
                localStorage.setItem('embermate_profiles', JSON.stringify(profiles));
            }
            
            showToast('App updated', `EmberMate has been updated to version ${toVersion}`, 'info');
        }

        function compareVersions(v1, v2) {
            // Simple semantic version comparison
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            
            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const num1 = parts1[i] || 0;
                const num2 = parts2[i] || 0;
                if (num1 < num2) return -1;
                if (num1 > num2) return 1;
            }
            return 0;
        }

        // ===== DATA EXPORT & IMPORT =====
        function showImportExportStatus(message) {
            const statusEl = document.getElementById('importExportStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
            }
        }

        function exportAllData() {
            const exportData = {
                version: APP_VERSION,
                exportDate: new Date().toISOString(),
                profiles: AppState.profiles,
                healthEntries: AppState.healthEntries,
                archivedEntries: JSON.parse(localStorage.getItem('embermate_archived_entries') || '[]'),
                onboardingComplete: localStorage.getItem('embermate_onboarding_completed') === 'true'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `embermate-backup-${timestamp}.json`;
            link.click();
            
            showToast('Export successful', 'Your data has been downloaded', 'success');
            
            // Update status
            showImportExportStatus(`Last exported: ${new Date().toLocaleDateString()} — source: JSON backup`);
        }

        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importData = JSON.parse(event.target.result);
                        
                        // Validate import data structure
                        if (!importData.profiles || !importData.healthEntries) {
                            showToast('Import failed', 'Invalid backup file format', 'error');
                            return;
                        }
                        
                        // Confirm import
                        if (!confirm('This will replace all current data with the backup. Continue?')) {
                            return;
                        }
                        
                        // Import profiles
                        AppState.profiles = importData.profiles;
                        localStorage.setItem('embermate_profiles', JSON.stringify(importData.profiles));
                        
                        // Import health entries
                        AppState.healthEntries = importData.healthEntries;
                        localStorage.setItem('embermate_health_entries', JSON.stringify(importData.healthEntries));
                        
                        // Import archived entries if present
                        if (importData.archivedEntries) {
                            localStorage.setItem('embermate_archived_entries', JSON.stringify(importData.archivedEntries));
                            AppState.archivedEntriesCount = importData.archivedEntries.length;
                        }
                        
                        // Import onboarding status
                        if (importData.onboardingComplete) {
                            localStorage.setItem('embermate_onboarding_completed', 'true');
                        }
                        
                        // Set imported version if available (for migration check on reload)
                        if (importData.version) {
                            localStorage.setItem('embermate_version', importData.version);
                        } else {
                            // Old backup without version - set to pre-2.10 to trigger migration
                            localStorage.setItem('embermate_version', '2.9.0');
                        }
                        
                        showToast('Import successful', 'Data restored from backup', 'success');
                        
                        // Update status
                        const importDate = importData.exportDate ? new Date(importData.exportDate).toLocaleDateString() : 'today';
                        showImportExportStatus(`Last imported: ${importDate} — source: JSON backup`);
                        
                        // Reload to reinitialize with imported data and run migrations
                        setTimeout(() => location.reload(), 1500);
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Import failed', 'Could not read backup file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check version and run migrations if needed
            checkVersionAndMigrate();
            
            // Update version display
            const versionDisplay = document.getElementById('appVersionDisplay');
            if (versionDisplay) {
                versionDisplay.textContent = APP_VERSION;
            }
            
            loadProfiles();
            
            // Check if user needs onboarding
            const hasCompletedOnboarding = localStorage.getItem('embermate_onboarding_completed');
            if (!hasCompletedOnboarding) {
                showOnboarding();
                return;
            }
            
            setupEventListeners();
            initializeSampleData();
            
            // Initialize debug panel (V2.12)
            initDebugPanel();
            
            // Initialize role UI
            updateRoleToggleUI(AppState.currentRole);
            
            // Initialize mode-aware home button (V2.12)
            updateModeHomeButton();
            
            renderCurrentView();
            
            // Set focus to skip link on page load for screen readers
            const skipLink = document.querySelector('.skip-link');
            if (skipLink) skipLink.focus();
        }

        function setupEventListeners() {
            // Role indicator keyboard support
            const roleIndicator = document.getElementById('roleIndicator');
            roleIndicator?.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleRole();
                }
            });

            // Profile switcher
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            
            profileBtn?.addEventListener('click', function(e) {
                e.stopPropagation();
                const isOpen = profileDropdown.classList.contains('show');
                profileDropdown.classList.toggle('show');
                profileBtn.setAttribute('aria-expanded', !isOpen);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!profileDropdown?.contains(e.target) && e.target !== profileBtn) {
                    profileDropdown?.classList.remove('show');
                    profileBtn?.setAttribute('aria-expanded', 'false');
                }
            });

            // Add profile button
            document.getElementById('addProfileBtn')?.addEventListener('click', function() {
                showModal('addProfileModal');
                document.getElementById('profileDropdown')?.classList.remove('show');
            });

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });

                // Keyboard navigation for tabs
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const tabName = this.dataset.tab;
                        switchTab(tabName);
                    }
                });
            });

            // Timeline filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    filterTimeline(this.dataset.filter);
                });
            });

            // Timeline date range
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    AppState.timelineRange = this.dataset.range;
                    renderTimeline();
                });
            });

            // Chart period controls
            document.querySelectorAll('.chart-control-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-control-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateCharts(this.dataset.period);
                });
            });

            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        closeModal(modal.id);
                    });
                }
            });

            // Quick action cards keyboard support
            document.querySelectorAll('.quick-action-card').forEach(card => {
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }

        // ===== PROFILE MANAGEMENT =====
        function loadProfiles() {
            const savedProfiles = localStorage.getItem('embermate_profiles');
            if (savedProfiles) {
                AppState.profiles = JSON.parse(savedProfiles);
            } else {
                // Create default profile
                AppState.profiles = [{
                    id: generateId(),
                    name: 'Demo User',
                    relation: 'self',
                    role: 'patient', // Default to patient view
                    dateOfBirth: null,
                    conditions: [],
                    avatar: '👤',
                    isActive: true
                }];
                saveProfiles();
            }

            AppState.currentProfile = AppState.profiles.find(p => p.isActive) || AppState.profiles[0];
            renderProfileList();
            updateProfileDisplay();
        }

        function saveProfiles() {
            localStorage.setItem('embermate_profiles', JSON.stringify(AppState.profiles));
        }

        function renderProfileList() {
            const profileList = document.getElementById('profileList');
            if (!profileList) return;

            profileList.innerHTML = AppState.profiles.map(profile => `
                <div class="profile-item ${profile.isActive ? 'active' : ''}" 
                     onclick="switchProfile('${profile.id}')"
                     role="menuitem"
                     tabindex="0">
                    <div class="profile-item-avatar">${profile.avatar}</div>
                    <div class="profile-item-info">
                        <div class="profile-item-name">${profile.name}</div>
                        <div class="profile-item-relation">${capitalizeFirst(profile.relation)}</div>
                    </div>
                    ${profile.isActive ? '<span class="profile-item-badge">Active</span>' : ''}
                </div>
            `).join('');

            // Add keyboard support for profile items
            profileList.querySelectorAll('.profile-item').forEach(item => {
                item.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        }

        function updateProfileDisplay() {
            const profile = AppState.currentProfile;
            document.getElementById('currentProfileName').textContent = profile.name;
            document.getElementById('currentProfileAvatar').textContent = profile.avatar;
            
            // Update quick action profile context
            const quickActionProfileName = document.getElementById('quick-action-profile-name');
            if (quickActionProfileName) {
                quickActionProfileName.textContent = profile.name;
            }
            
            // Update role toggle button
            const currentRole = profile.role || 'patient';
            updateRoleToggleUI(currentRole);
        }

        function switchProfile(profileId) {
            AppState.profiles.forEach(p => p.isActive = (p.id === profileId));
            AppState.currentProfile = AppState.profiles.find(p => p.id === profileId);
            
            saveProfiles();
            renderProfileList();
            updateProfileDisplay();
            
            // Update role toggle button to match profile's role
            const currentRole = AppState.currentProfile.role || 'patient';
            updateRoleToggleUI(currentRole);
            
            renderCurrentView();
            
            document.getElementById('profileDropdown')?.classList.remove('show');
            document.getElementById('profileBtn')?.setAttribute('aria-expanded', 'false');
            
            showToast('Profile switched', `Now viewing ${AppState.currentProfile.name}'s health data`, 'info');
        }

        function createNewProfile() {
            const name = document.getElementById('newProfileName').value.trim();
            const relation = document.getElementById('newProfileRelation').value;

            if (!name) {
                showToast('Error', 'Please enter a name', 'error');
                return;
            }

            const newProfile = {
                id: generateId(),
                name: name,
                relation: relation,
                role: 'patient', // Default to patient view
                dateOfBirth: null,
                conditions: [],
                avatar: name[0].toUpperCase(),
                isActive: false
            };

            AppState.profiles.push(newProfile);
            saveProfiles();
            renderProfileList();
            
            closeModal('addProfileModal');
            showToast('Profile created', `${name}'s profile has been added`, 'success');
            
            // Clear form
            document.getElementById('newProfileName').value = '';
            document.getElementById('newProfileRelation').value = 'self';
        }

        // ===== TAB NAVIGATION =====
        function switchTab(tabName) {
            AppState.currentTab = tabName;

            // UC10: Hide debug tab when switching away from it
            if (AppState.previousTab === 'debug' && tabName !== 'debug') {
                hideDebugPanel();
            }
            AppState.previousTab = tabName;

            // Update tab states
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const isActive = tab.dataset.tab === tabName;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive);
                tab.setAttribute('tabindex', isActive ? '0' : '-1');
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-panel`)?.classList.add('active');

            // Special handling for analytics tab
            if (tabName === 'analytics') {
                setTimeout(() => initializeCharts(), 100);
            }
            
            // Update archived entries notice on profile tab
            if (tabName === 'profile') {
                updateArchivedEntriesNotice();
            }
        }

        function updateArchivedEntriesNotice() {
            const notice = document.getElementById('archivedEntriesNotice');
            const countSpan = document.getElementById('archivedCount');
            
            if (notice && countSpan && AppState.archivedEntriesCount > 0) {
                countSpan.textContent = AppState.archivedEntriesCount;
                notice.style.display = 'block';
            } else if (notice) {
                notice.style.display = 'none';
            }
        }

        // ===== MODAL MANAGEMENT =====
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Trap focus in modal
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            // Focus first element
            setTimeout(() => firstFocusable?.focus(), 100);

            // Handle tab key
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                }
            });
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal?.classList.remove('show');
            document.body.style.overflow = '';
        }

        // ESC key handler for non-critical modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    // Don't allow ESC to close onboarding modal
                    if (modal.id !== 'onboardingModal') {
                        closeModal(modal.id);
                    }
                });
            }
        });

        // ===== TOAST NOTIFICATIONS =====
        function showToast(title, message, type = 'info', onComplete = null) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const iconMap = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${iconMap[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" aria-label="Close notification">&times;</button>
            `;

            // Click-to-close
            toast.querySelector('.toast-close').addEventListener('click', () => {
                removeToast(toast, onComplete);
            });

            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                removeToast(toast, onComplete);
            }, 4000);
        }

        // Show inline confirmation in card instead of toast
        function showInlineConfirmation(elementId, message, emoji = '✓') {
            const element = document.getElementById(elementId);
            if (!element) return;

            const confirmation = document.createElement('div');
            confirmation.style.cssText = 'color: var(--success); font-size: 0.875rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.25rem;';
            confirmation.innerHTML = `<span>${emoji}</span> <span>${message}</span>`;
            
            element.appendChild(confirmation);
            setTimeout(() => confirmation.remove(), 2000);
        }

        function removeToast(toast, onComplete = null) {
            toast.classList.add('removing');
            setTimeout(() => {
                toast.remove();
                if (onComplete && typeof onComplete === 'function') {
                    onComplete();
                }
            }, 200);
        }

        // ===== CAREGIVER QUICK ACTIONS (V2.7) =====
        function logAllMedsDone() {
            const profile = AppState.currentProfile;
            
            // Create timeline entry for medication logging
            const entry = {
                id: generateId(),
                type: 'medication',
                profileId: profile.id,
                profileName: profile.name,
                timestamp: new Date().toISOString(),
                content: `All medications marked as taken`,
                notes: 'Quick-logged via Meds Done button'
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();
            
            // Single toast confirmation - caregiver-focused
            showToast(
                'Medications logged',
                `All medications marked as taken for ${profile.name} 💊`,
                'success'
            );

            // Refresh view to show new timeline entry
            renderCurrentView();
        }

        function showAskForVitalsModal() {
            const profileIndicator = AppState.currentProfile 
                ? `<div class="form-profile-indicator">
                       📋 Reminder for: <strong>${AppState.currentProfile.name}</strong>
                   </div>` 
                : '';

            const modalBody = profileIndicator + `
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" placeholder="Time to check your vitals! 🩺">Time to check your vitals! Don't forget to log your blood pressure and blood sugar.</textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="sendVitalsReminder()">Send a gentle reminder</button>
                </div>
            `;

            document.getElementById('quickAddModalTitle').textContent = 'Ask for Vitals';
            document.getElementById('quickAddModalBody').innerHTML = modalBody;
            showModal('quickAddModal');
        }

        function sendVitalsReminder() {
            showToast(
                'Reminder sent',
                'Vitals check reminder sent successfully 📲',
                'success',
                () => {
                    // After toast, offer recurring reminder
                    setTimeout(() => {
                        if (confirm(`Make this a daily reminder at ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}?`)) {
                            showToast('Daily reminder set', 'You\'ll be reminded to ask for vitals daily', 'info');
                        }
                    }, 1500);
                }
            );
            closeModal('quickAddModal');
        }

        function showAddNoteForTomorrowModal() {
            const profileIndicator = AppState.currentProfile 
                ? `<div class="form-profile-indicator">
                       📋 Reminder for: <strong>${AppState.currentProfile.name}</strong>
                   </div>` 
                : '';

            const modalBody = profileIndicator + `
                <div class="form-group">
                    <label class="form-label">Reminder for</label>
                    <input type="date" class="form-input" value="${getTomorrowDate()}">
                </div>
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea class="form-textarea" placeholder="Enter reminder note..." autofocus></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveReminderNote()">Set this reminder</button>
                </div>
            `;

            document.getElementById('quickAddModalTitle').textContent = 'Add Note for Tomorrow';
            document.getElementById('quickAddModalBody').innerHTML = modalBody;
            showModal('quickAddModal');
        }

        function saveReminderNote() {
            showToast(
                'Reminder saved',
                `Note scheduled for ${AppState.currentProfile.name} 📝`,
                'success'
            );
            closeModal('quickAddModal');
        }

        // ===== QUICK ADD MODAL =====
        function showQuickAddModal(type) {
            let modalContent = '';

            switch(type) {
                case 'vitals':
                    modalContent = getVitalsForm();
                    break;
                case 'glucose':
                    modalContent = getGlucoseForm();
                    break;
                case 'medication':
                    modalContent = getMedicationForm();
                    break;
                case 'weight':
                    modalContent = getWeightForm();
                    break;
                case 'mood':
                    modalContent = getMoodForm();
                    break;
                default:
                    modalContent = '<p>Select an entry type</p>';
            }

            // Add profile indicator if in caretaker mode
            const profileIndicator = AppState.currentRole === 'caretaker' && AppState.currentProfile 
                ? `<div class="form-profile-indicator">
                       📋 Logging for: <strong>${AppState.currentProfile.name}</strong>
                   </div>` 
                : '';

            document.getElementById('quickAddModalTitle').textContent = `Add ${capitalizeFirst(type)}`;
            document.getElementById('quickAddModalBody').innerHTML = profileIndicator + modalContent;
            showModal('quickAddModal');
        }

        function getVitalsForm() {
            return `
                <div class="form-group">
                    <label class="form-label">Systolic (top number)</label>
                    <input type="number" class="form-input" id="systolic" placeholder="120" autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label">Diastolic (bottom number)</label>
                    <input type="number" class="form-input" id="diastolic" placeholder="80">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-textarea" id="vitalsNotes" placeholder="How are you feeling?"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveVitals()">Log this reading</button>
                </div>
            `;
        }

        function getGlucoseForm() {
            return `
                <div class="form-group">
                    <label class="form-label">Blood Sugar (mg/dL)</label>
                    <input type="number" class="form-input" id="glucose" placeholder="96" autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label">Timing</label>
                    <select class="form-select" id="glucoseTiming">
                        <option value="fasting">Fasting</option>
                        <option value="before-meal">Before Meal</option>
                        <option value="after-meal">After Meal</option>
                        <option value="bedtime">Bedtime</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-textarea" id="glucoseNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveGlucose()">Log this reading</button>
                </div>
            `;
        }

        function getMedicationForm() {
            return `
                <div class="form-group">
                    <label class="form-label">Medication Name</label>
                    <input type="text" class="form-input" id="medName" placeholder="e.g., Lisinopril" autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label">Dosage</label>
                    <input type="text" class="form-input" id="medDosage" placeholder="e.g., 10mg">
                </div>
                <div class="form-group">
                    <label class="form-label">Time Taken</label>
                    <input type="time" class="form-input" id="medTime">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveMedication()">Mark as done</button>
                </div>
            `;
        }

        function getWeightForm() {
            return `
                <div class="form-group">
                    <label class="form-label">Weight</label>
                    <div class="flex gap-2">
                        <input type="number" class="form-input" id="weight" placeholder="150" step="0.1" autofocus>
                        <select class="form-select" id="weightUnit" style="width: auto;">
                            <option value="lbs">lbs</option>
                            <option value="kg">kg</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-textarea" id="weightNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveWeight()">Log this weight</button>
                </div>
            `;
        }

        function getMoodForm() {
            return `
                <div class="form-group">
                    <label class="form-label">How are you feeling?</label>
                    <div class="health-buddy-mood-selector">
                        <button class="health-buddy-mood-btn" onclick="selectMood('great')" aria-label="Feeling great">😄</button>
                        <button class="health-buddy-mood-btn" onclick="selectMood('good')" aria-label="Feeling good">😊</button>
                        <button class="health-buddy-mood-btn" onclick="selectMood('okay')" aria-label="Feeling okay">😐</button>
                        <button class="health-buddy-mood-btn" onclick="selectMood('tired')" aria-label="Feeling tired">😴</button>
                        <button class="health-buddy-mood-btn" onclick="selectMood('unwell')" aria-label="Not feeling well">😷</button>
                    </div>
                    <input type="hidden" id="selectedMood">
                </div>
                <div class="form-group">
                    <label class="form-label">Any notes? (optional)</label>
                    <textarea class="form-textarea" id="moodNotes" placeholder="What's on your mind?"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveMood()">Log how I'm feeling</button>
                </div>
            `;
        }

        function selectMood(mood) {
            document.querySelectorAll('.health-buddy-mood-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('selectedMood').value = mood;
        }

        // Save functions
        function saveVitals() {
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            const notes = document.getElementById('vitalsNotes').value;

            if (!systolic || !diastolic) {
                showToast('Error', 'Please enter both systolic and diastolic values', 'error');
                return;
            }

            // PHI Guard check on notes
            if (notes) {
                const phiCheck = checkForPHI(notes);
                if (phiCheck) {
                    showToast('⚠️ Privacy reminder', phiCheck.message, 'warning');
                }
            }

            // Save to AppState with profile tagging
            const entry = {
                id: generateId(),
                type: 'vitals',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { systolic, diastolic },
                content: `Blood pressure: ${systolic}/${diastolic} mmHg${notes ? ' - ' + notes : ''}`,
                notes
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            // Show inline confirmation in modal before closing
            showInlineConfirmation('quickAddModalBody', 'Blood pressure recorded');
            
            // Close modal and update view after brief delay for confirmation visibility
            setTimeout(() => {
                closeModal('quickAddModal');
                renderCurrentView();
                
                // Update analytics if visible
                if (AppState.currentTab === 'analytics') {
                    renderAnalytics();
                }
            }, 1500);
        }

        function saveGlucose() {
            const glucose = document.getElementById('glucose').value;
            const timing = document.getElementById('glucoseTiming').value;
            const notes = document.getElementById('glucoseNotes').value;

            if (!glucose) {
                showToast('Error', 'Please enter blood sugar value', 'error');
                return;
            }

            // PHI Guard check on notes
            if (notes) {
                const phiCheck = checkForPHI(notes);
                if (phiCheck) {
                    showToast('⚠️ Privacy reminder', phiCheck.message, 'warning');
                }
            }

            const entry = {
                id: generateId(),
                type: 'glucose',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { glucose, timing },
                content: `Blood sugar: ${glucose} mg/dL (${timing})${notes ? ' - ' + notes : ''}`,
                notes
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            // Show inline confirmation in modal before closing
            showInlineConfirmation('quickAddModalBody', 'Blood sugar recorded');
            
            // Close modal and update view after brief delay for confirmation visibility
            setTimeout(() => {
                closeModal('quickAddModal');
                renderCurrentView();
                
                // Update analytics if visible
                if (AppState.currentTab === 'analytics') {
                    renderAnalytics();
                }
            }, 1500);
        }

        function saveMedication() {
            const name = document.getElementById('medName').value;
            const dosage = document.getElementById('medDosage').value;
            const time = document.getElementById('medTime').value;

            if (!name || !dosage) {
                showToast('Error', 'Please enter medication name and dosage', 'error');
                return;
            }

            const entry = {
                id: generateId(),
                type: 'medication',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { name, dosage, time },
                content: `${name} - ${dosage}${time ? ' at ' + time : ''}`,
                notes: ''
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            closeModal('quickAddModal');
            showToast('Perfect!', `${name} logged successfully 💊`, 'success');
            renderCurrentView();
            
            // Update medications tab if visible
            if (AppState.currentTab === 'medications') {
                renderMedications();
            }
            
            // Update analytics if visible
            if (AppState.currentTab === 'analytics') {
                renderAnalytics();
            }
        }

        function saveWeight() {
            const weight = document.getElementById('weight').value;
            const unit = document.getElementById('weightUnit').value;
            const notes = document.getElementById('weightNotes').value;

            if (!weight) {
                showToast('Error', 'Please enter weight', 'error');
                return;
            }

            // PHI Guard check on notes
            if (notes) {
                const phiCheck = checkForPHI(notes);
                if (phiCheck) {
                    showToast('⚠️ Privacy reminder', phiCheck.message, 'warning');
                }
            }

            const entry = {
                id: generateId(),
                type: 'weight',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { weight, unit },
                content: `Weight: ${weight} ${unit}${notes ? ' - ' + notes : ''}`,
                notes
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            closeModal('quickAddModal');
            // Inline confirmation instead of toast
            showInlineConfirmation('healthLogContent', 'Weight recorded');
            renderCurrentView();
        }

        function saveMood() {
            const mood = document.getElementById('selectedMood').value;
            const notes = document.getElementById('moodNotes').value;

            if (!mood) {
                showToast('Error', 'Please select a mood', 'error');
                return;
            }

            // PHI Guard check on notes
            if (notes) {
                const phiCheck = checkForPHI(notes);
                if (phiCheck) {
                    showToast('⚠️ Privacy reminder', phiCheck.message, 'warning');
                }
            }

            const entry = {
                id: generateId(),
                type: 'mood',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { mood },
                content: `Feeling ${mood}${notes ? ' - ' + notes : ''}`,
                notes
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            closeModal('quickAddModal');
            // Inline confirmation instead of toast
            showInlineConfirmation('healthLogContent', 'Mood logged');
            renderCurrentView();
        }

        function logMood(mood) {
            const entry = {
                id: generateId(),
                type: 'mood',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { mood },
                content: `Feeling ${mood}`,
                notes: ''
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            // Inline confirmation instead of toast
            showInlineConfirmation('healthLogContent', 'Mood logged');
            renderCurrentView();
        }

        // ===== DATA PERSISTENCE =====
        function saveHealthEntries() {
            // Archive old entries if profile exceeds limit
            archiveOldEntriesIfNeeded();
            localStorage.setItem('embermate_health_entries', JSON.stringify(AppState.healthEntries));
        }

        function loadHealthEntries() {
            const saved = localStorage.getItem('embermate_health_entries');
            if (saved) {
                AppState.healthEntries = JSON.parse(saved);
            }
            
            // Load archived count
            const archivedData = localStorage.getItem('embermate_archived_entries');
            if (archivedData) {
                const archived = JSON.parse(archivedData);
                AppState.archivedEntriesCount = archived.length || 0;
            }
        }

        function archiveOldEntriesIfNeeded() {
            if (!AppState.currentProfile) return;
            
            // Count entries for current profile
            const profileEntries = AppState.healthEntries.filter(
                entry => entry.profileId === AppState.currentProfile.id
            );
            
            const profileCount = profileEntries.length;
            
            // Show warning if approaching limit
            if (profileCount >= APP_CONFIG.ARCHIVE_WARNING_THRESHOLD && 
                profileCount < APP_CONFIG.MAX_ENTRIES_PER_PROFILE) {
                const remaining = APP_CONFIG.MAX_ENTRIES_PER_PROFILE - profileCount;
                showToast(
                    'Storage notice', 
                    `${remaining} entries remaining. Older entries will be archived soon to keep the app fast.`, 
                    'info'
                );
            }
            
            // Archive if limit exceeded
            if (profileCount > APP_CONFIG.MAX_ENTRIES_PER_PROFILE) {
                const entriesToArchive = profileCount - APP_CONFIG.MAX_ENTRIES_PER_PROFILE + APP_CONFIG.CLEANUP_BATCH_SIZE;
                
                // Sort profile entries by date (oldest first)
                const sortedEntries = [...profileEntries].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                // Take oldest entries to archive
                const oldestEntries = sortedEntries.slice(0, entriesToArchive);
                const oldestIds = new Set(oldestEntries.map(e => e.id));
                
                // Load existing archived entries
                const archivedData = localStorage.getItem('embermate_archived_entries');
                const archived = archivedData ? JSON.parse(archivedData) : [];
                
                // Add entries to archive
                archived.push(...oldestEntries);
                
                // Remove from active entries
                AppState.healthEntries = AppState.healthEntries.filter(
                    entry => !oldestIds.has(entry.id)
                );
                
                // Save archived entries
                localStorage.setItem('embermate_archived_entries', JSON.stringify(archived));
                AppState.archivedEntriesCount = archived.length;
                
                // Notify user
                showToast(
                    'Entries archived', 
                    `${entriesToArchive} older entries were archived to keep the app fast.`, 
                    'success'
                );
            }
        }

        // ===== SAMPLE DATA =====
        function initializeSampleData() {
            // Check if already seeded
            if (localStorage.getItem('embermate_seeded')) {
                loadHealthEntries();
                return;
            }

            // Create 3 demo profiles
            const profiles = [
                {
                    id: generateId(),
                    name: 'Mila',
                    role: 'patient',
                    relation: 'Daughter',
                    age: 8,
                    avatar: '👧',
                    color: '#FF69B4',
                    conditions: ['Asthma'],
                    allergies: ['Peanuts'],
                    emergencyContact: 'School Nurse: (555) 123-4567',
                    medications: []
                },
                {
                    id: generateId(),
                    name: 'Mom',
                    role: 'patient',
                    relation: 'Parent',
                    age: 62,
                    avatar: '👵',
                    color: '#9370DB',
                    conditions: ['Hypertension', 'Type 2 Diabetes'],
                    allergies: ['Penicillin'],
                    emergencyContact: 'Dr. Smith: (555) 987-6543',
                    medications: [
                        {
                            id: generateId(),
                            name: 'Lisinopril',
                            dosage: '10mg',
                            frequency: 'Daily',
                            time: '08:00',
                            instructions: 'Take with water',
                            reminderEnabled: true
                        },
                        {
                            id: generateId(),
                            name: 'Metformin',
                            dosage: '500mg',
                            frequency: 'Daily',
                            time: '18:00',
                            instructions: 'Take with food',
                            reminderEnabled: true
                        }
                    ]
                },
                {
                    id: generateId(),
                    name: 'Amber',
                    role: 'patient',
                    relation: 'Self',
                    age: 35,
                    avatar: '🦸‍♀️',
                    color: '#FF6B35',
                    conditions: ['Migraine'],
                    allergies: [],
                    emergencyContact: 'Partner: (555) 246-8135',
                    medications: []
                }
            ];

            // Save profiles
            AppState.profiles = profiles;
            AppState.currentProfile = profiles[0];
            saveProfiles();

            // Create timeline entries for all profiles
            const entries = [];
            const now = Date.now();
            const dayMs = 24 * 60 * 60 * 1000;

            profiles.forEach((profile, profileIndex) => {
                for (let day = 0; day < 7; day++) {
                    const dayDate = new Date(now - (day * dayMs));
                    
                    // Medication logs for Mom
                    if (profile.name === 'Mom') {
                        // Morning medication
                        const morning = new Date(dayDate);
                        morning.setHours(8, 0, 0, 0);
                        entries.push({
                            id: generateId(),
                            type: 'medication',
                            profileId: profile.id,
                            profileName: profile.name,
                            timestamp: morning.toISOString(),
                            data: { 
                                name: 'Lisinopril', 
                                dosage: '10mg',
                                taken: day < 5 // Missed last 2 days
                            },
                            content: `Lisinopril 10mg ${day < 5 ? '✓ Taken' : '✗ Missed'}`,
                            notes: day === 0 ? 'Running low - need refill' : ''
                        });

                        // Evening medication
                        const evening = new Date(dayDate);
                        evening.setHours(18, 0, 0, 0);
                        entries.push({
                            id: generateId(),
                            type: 'medication',
                            profileId: profile.id,
                            profileName: profile.name,
                            timestamp: evening.toISOString(),
                            data: { 
                                name: 'Metformin', 
                                dosage: '500mg',
                                taken: day < 6
                            },
                            content: `Metformin 500mg ${day < 6 ? '✓ Taken' : '✗ Missed'}`,
                            notes: ''
                        });
                    }

                    // Vitals for Mom and Amber
                    if (profile.name === 'Mom' || profile.name === 'Amber') {
                        const vitalTime = new Date(dayDate);
                        vitalTime.setHours(10, 0, 0, 0);
                        
                        // Blood Pressure
                        entries.push({
                            id: generateId(),
                            type: 'vitals',
                            profileId: profile.id,
                            profileName: profile.name,
                            timestamp: vitalTime.toISOString(),
                            data: { 
                                systolic: 120 + day * 2, 
                                diastolic: 75 + day,
                                heartRate: 72 + day * 2,
                                oxygen: 97 + (day % 3)
                            },
                            content: `BP: ${120 + day * 2}/${75 + day} mmHg | HR: ${72 + day * 2} bpm | O2: ${97 + (day % 3)}%`,
                            notes: day === 0 ? 'Feeling good today' : ''
                        });
                    }

                    // Daily mood entry
                    const moods = [
                        { emoji: '😊', label: 'Great', note: day === 0 ? 'Note for tomorrow: Early appointment' : '' },
                        { emoji: '😌', label: 'Good', note: '' },
                        { emoji: '😐', label: 'Okay', note: '' },
                        { emoji: '😔', label: 'Low', note: day === 2 ? 'Felt tired today' : '' },
                        { emoji: '😫', label: 'Struggling', note: '' }
                    ];
                    const mood = moods[Math.floor(Math.random() * moods.length)];
                    const moodTime = new Date(dayDate);
                    moodTime.setHours(20, 0, 0, 0);
                    
                    entries.push({
                        id: generateId(),
                        type: 'mood',
                        profileId: profile.id,
                        profileName: profile.name,
                        timestamp: moodTime.toISOString(),
                        data: { mood: mood.emoji, label: mood.label },
                        content: `Mood: ${mood.emoji} ${mood.label}`,
                        notes: mood.note
                    });
                }
            });

            // Add upcoming appointment for Mom
            const appointmentDate = new Date(now + (2 * dayMs));
            appointmentDate.setHours(10, 0, 0, 0);
            const momProfile = profiles.find(p => p.name === 'Mom');
            
            entries.push({
                id: generateId(),
                type: 'appointment',
                profileId: momProfile.id,
                profileName: momProfile.name,
                timestamp: appointmentDate.toISOString(),
                data: { 
                    title: 'Follow-up with PCP',
                    type: 'Telehealth',
                    provider: 'Dr. Smith'
                },
                content: 'Follow-up with PCP (Telehealth) @ 10:00 AM',
                notes: 'Review post-op progress and medication management'
            });

            // Save all entries
            AppState.healthEntries = entries.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            saveHealthEntries();

            // Mark as seeded
            localStorage.setItem('embermate_seeded', 'true');
        }

        // ===== TIMELINE =====
        function updateAISummary() {
            const summaryEl = document.getElementById('aiSummaryText');
            if (!summaryEl) return;

            const role = AppState.currentProfile.role || 'patient';
            const name = AppState.currentProfile.name;

            // Mode-aware copy - caregiver vs patient language
            if (role === 'caretaker') {
                summaryEl.textContent = `You're doing great today! ${name}'s medications tracked consistently, and vitals are within target range. Keep logging their health data regularly. You're doing excellent work! 🌟`;
            } else {
                summaryEl.textContent = `You're doing great today! Medications tracked consistently, and vitals are within target range. Keep logging your health data regularly. You're making excellent progress! 🌟`;
            }
        }

        function filterTimeline(filter) {
            AppState.timelineFilter = filter;
            renderTimeline();
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            if (!container) return;

            // Update AI summary based on role
            updateAISummary();

            // Filter entries by type
            let entries = AppState.healthEntries.filter(entry => {
                if (AppState.timelineFilter === 'all') return true;
                // Handle both 'symptom' and 'symptoms' for backward compatibility
                if (AppState.timelineFilter === 'symptoms') {
                    return entry.type === 'symptom' || entry.type === 'symptoms';
                }
                return entry.type === AppState.timelineFilter;
            });

            // Filter by date range
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(todayStart);
            weekStart.setDate(weekStart.getDate() - 7);

            entries = entries.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                if (AppState.timelineRange === 'today') {
                    return entryDate >= todayStart;
                } else if (AppState.timelineRange === 'week') {
                    return entryDate >= weekStart;
                }
                return true; // 'all'
            });

            // Sort by newest first
            entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Group by date
            const grouped = {};
            entries.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dateKey = date.toDateString();
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(entry);
            });

            // Render timeline
            let html = '';
            Object.keys(grouped).forEach(dateKey => {
                const date = new Date(dateKey);
                const isToday = date.toDateString() === new Date().toDateString();
                const isYesterday = date.toDateString() === new Date(Date.now() - 86400000).toDateString();
                
                let dateLabel = isToday ? 'Today' : isYesterday ? 'Yesterday' : date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

                html += `
                    <div class="timeline-date-group">
                        <div class="timeline-date-header">
                            <h3>${dateLabel}</h3>
                        </div>
                `;

                grouped[dateKey].forEach(entry => {
                    const time = new Date(entry.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    const typeLabel = entry.type.charAt(0).toUpperCase() + entry.type.slice(1);
                    
                    html += `
                        <article class="timeline-entry ${entry.type}">
                            <div class="timeline-entry-header">
                                <span class="timeline-entry-type">${typeLabel}</span>
                                <span class="timeline-entry-time">${time}</span>
                            </div>
                            <div class="timeline-entry-content">
                                ${entry.content}
                            </div>
                        </article>
                    `;
                });

                html += '</div>';
            });

            if (html === '') {
                html = `
                    <div class="timeline-empty">
                        <p>No entries found for this time period.</p>
                        <p>Start logging your health data to see your timeline!</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderCurrentView() {
            // Re-render based on current tab
            if (!AppState.currentProfile) return;
            
            console.log('Rendering view for profile:', AppState.currentProfile.name);
            
            // Link demo medications to current profile if not already linked
            AppState.medications.forEach(med => {
                if (!med.profileId) {
                    med.profileId = AppState.currentProfile.id;
                }
            });
            
            // Show/hide caregiver-specific features based on role
            updateRoleBasedUI();
            
            // Render based on current tab
            if (AppState.currentTab === 'healthLog') {
                renderTimeline();
            } else if (AppState.currentTab === 'medications') {
                renderMedications();
            } else if (AppState.currentTab === 'analytics') {
                renderAnalytics();
            }
        }

        function updateRoleBasedUI() {
            if (!AppState.currentProfile) return;
            
            const role = AppState.currentProfile.role || 'patient';
            const caregiverSection = document.getElementById('caregiverQuickActions');
            
            if (caregiverSection) {
                // Show caregiver quick actions only in caretaker mode
                caregiverSection.style.display = role === 'caretaker' ? 'block' : 'none';
            }
        }

        // ===== MEDICATIONS RENDERING =====
        function renderMedications() {
            const container = document.getElementById('medicationsContainer');
            if (!container) return;
            
            const profileMeds = AppState.medications.filter(m => 
                m.profileId === AppState.currentProfile.id
            );
            
            if (profileMeds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💊</div>
                        <div class="empty-state-title">No medications yet</div>
                        <p class="empty-state-message">
                            Add your first medication to start tracking
                        </p>
                        <button class="btn btn-primary" onclick="showAddMedicationModal()">
                            Add First Medication
                        </button>
                    </div>
                `;
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            container.innerHTML = profileMeds.map(med => {
                // Check if med was taken today
                const takenToday = AppState.healthEntries.some(entry => 
                    entry.type === 'medication' &&
                    entry.data.name === med.name &&
                    entry.timestamp.startsWith(today) &&
                    entry.profileId === AppState.currentProfile.id
                );
                
                return `
                    <div class="med-card">
                        <div class="med-header">
                            <div class="med-name">${med.name}</div>
                            <div class="med-dosage">${med.dosage}</div>
                        </div>
                        <div class="med-details">
                            <div class="med-frequency">
                                <span class="med-icon">🔄</span>
                                ${med.frequency}
                            </div>
                            <div class="med-times">
                                <span class="med-icon">⏰</span>
                                ${med.times.join(', ')}
                            </div>
                        </div>
                        ${med.notes ? `<div class="med-notes">${med.notes}</div>` : ''}
                        <div class="med-actions">
                            ${takenToday ? 
                                `<div class="badge badge-success">✓ Taken today</div>` :
                                `<button class="btn btn-primary btn-sm" onclick="markMedTaken('${med.id}', '${med.name}', '${med.dosage}')">
                                    Mark as taken
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markMedTaken(medId, medName, medDosage) {
            const entry = {
                id: generateId(),
                type: 'medication',
                profileId: AppState.currentProfile.id,
                profileName: AppState.currentProfile.name,
                timestamp: new Date().toISOString(),
                data: { 
                    name: medName, 
                    dosage: medDosage,
                    medId: medId
                },
                content: `${medName} - ${medDosage}`,
                notes: 'Logged from medications tab'
            };

            AppState.healthEntries.push(entry);
            saveHealthEntries();

            // Inline confirmation instead of toast
            showInlineConfirmation('medicationsContainer', `${medName} marked as taken`);
            renderMedications();
            
            // Also update analytics if on that tab
            if (AppState.currentTab === 'analytics') {
                renderAnalytics();
            }
        }

        // ===== CHARTS =====
        function renderAnalytics() {
            updateAnalyticsStats();
            initializeCharts();
            renderVitalsTable();
        }

        function updateAnalyticsStats() {
            const today = new Date().toISOString().split('T')[0];
            const profileEntries = AppState.healthEntries.filter(e => 
                e.profileId === AppState.currentProfile.id
            );
            
            // Medication adherence
            const medEntriesToday = profileEntries.filter(e => 
                e.type === 'medication' && e.timestamp.startsWith(today)
            );
            const totalMedsToday = AppState.medications.filter(m => 
                m.profileId === AppState.currentProfile.id
            ).length;
            
            const adherenceRate = totalMedsToday > 0 ? 
                Math.round((medEntriesToday.length / totalMedsToday) * 100) : 0;
            const adherenceLabel = adherenceRate >= 80 ? 'Excellent' : 
                                   adherenceRate >= 50 ? 'Good' : 'Needs attention';
            
            // Update stat cards
            const medStatValue = document.querySelector('.stat-card:nth-child(1) .stat-value');
            const medStatDesc = document.querySelector('.stat-card:nth-child(1) .stat-description');
            if (medStatValue) medStatValue.textContent = adherenceLabel;
            if (medStatDesc) medStatDesc.textContent = `${adherenceRate}% this week`;
            
            // Vital readings count
            const vitalEntries = profileEntries.filter(e => 
                e.type === 'vitals' || e.type === 'glucose' || e.type === 'weight'
            );
            const vitalCount = vitalEntries.length;
            const vitalStatValue = document.querySelector('.stat-card:nth-child(2) .stat-value');
            const vitalStatDesc = document.querySelector('.stat-card:nth-child(2) .stat-description');
            if (vitalStatValue) vitalStatValue.textContent = vitalCount;
            if (vitalStatDesc) vitalStatDesc.textContent = vitalCount > 5 ? 'Great tracking!' : 'Keep logging!';
        }

        function initializeCharts() {
            const profileEntries = AppState.healthEntries.filter(e => 
                e.profileId === AppState.currentProfile.id
            );
            
            // Get last 7 days of BP data
            const bpData = getLast7DaysData(profileEntries, 'vitals');
            const glucoseData = getLast7DaysData(profileEntries, 'glucose');
            
            // Destroy existing charts if they exist
            if (AppState.charts.bp) AppState.charts.bp.destroy();
            if (AppState.charts.glucose) AppState.charts.glucose.destroy();
            
            // Blood Pressure Chart
            const bpCtx = document.getElementById('bpChart');
            if (bpCtx && bpCtx.getContext) {
                if (bpData.labels.length < 3) {
                    // Not enough data - show message
                    bpCtx.parentElement.innerHTML = `
                        <div class="chart-header">
                            <h3 class="chart-title">Blood Pressure Trend</h3>
                        </div>
                        <div style="padding: 60px 20px; text-align: center; color: var(--text-tertiary);">
                            📊 Not enough data yet<br>
                            <small>Log 3+ readings to see trends</small>
                        </div>
                    `;
                } else {
                    AppState.charts.bp = new Chart(bpCtx, {
                        type: 'line',
                        data: {
                            labels: bpData.labels,
                            datasets: [
                                {
                                    label: 'Systolic',
                                    data: bpData.systolic,
                                    borderColor: '#CD876E',
                                    backgroundColor: 'rgba(205, 135, 110, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'Diastolic',
                                    data: bpData.diastolic,
                                    borderColor: '#81A684',
                                    backgroundColor: 'rgba(129, 166, 132, 0.1)',
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: 'var(--text-secondary)' }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: { color: 'var(--text-tertiary)' },
                                    grid: { color: 'var(--border-color)' }
                                },
                                x: {
                                    ticks: { color: 'var(--text-tertiary)' },
                                    grid: { color: 'var(--border-color)' }
                                }
                            }
                        }
                    });
                }
            }

            // Blood Sugar Chart
            const bsCtx = document.getElementById('bsChart');
            if (bsCtx && bsCtx.getContext) {
                if (glucoseData.labels.length < 3) {
                    // Not enough data - show message
                    bsCtx.parentElement.innerHTML = `
                        <div class="chart-header">
                            <h3 class="chart-title">Blood Sugar Trend</h3>
                        </div>
                        <div style="padding: 60px 20px; text-align: center; color: var(--text-tertiary);">
                            📊 Not enough data yet<br>
                            <small>Log 3+ readings to see trends</small>
                        </div>
                    `;
                } else {
                    AppState.charts.glucose = new Chart(bsCtx, {
                        type: 'line',
                        data: {
                            labels: glucoseData.labels,
                            datasets: [{
                                label: 'Blood Sugar (mg/dL)',
                                data: glucoseData.values,
                                borderColor: '#EFBE9E',
                                backgroundColor: 'rgba(239, 190, 158, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: 'var(--text-secondary)' }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: { color: 'var(--text-tertiary)' },
                                    grid: { color: 'var(--border-color)' },
                                    suggestedMin: 70,
                                    suggestedMax: 140
                                },
                                x: {
                                    ticks: { color: 'var(--text-tertiary)' },
                                    grid: { color: 'var(--border-color)' }
                                }
                            }
                        }
                    });
                }
            }
        }

        function getLast7DaysData(entries, type) {
            const result = { labels: [], systolic: [], diastolic: [], values: [] };
            const days = [];
            
            // Get last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toISOString().split('T')[0]);
            }
            
            days.forEach(day => {
                const dayEntries = entries.filter(e => 
                    e.type === type && e.timestamp.startsWith(day)
                );
                
                if (dayEntries.length > 0) {
                    const dayLabel = new Date(day).toLocaleDateString('en-US', { weekday: 'short' });
                    result.labels.push(dayLabel);
                    
                    if (type === 'vitals') {
                        // Average BP for the day
                        const avgSys = Math.round(
                            dayEntries.reduce((sum, e) => sum + parseInt(e.data.systolic), 0) / dayEntries.length
                        );
                        const avgDia = Math.round(
                            dayEntries.reduce((sum, e) => sum + parseInt(e.data.diastolic), 0) / dayEntries.length
                        );
                        result.systolic.push(avgSys);
                        result.diastolic.push(avgDia);
                    } else if (type === 'glucose') {
                        // Average glucose for the day
                        const avgGlucose = Math.round(
                            dayEntries.reduce((sum, e) => sum + parseInt(e.data.glucose), 0) / dayEntries.length
                        );
                        result.values.push(avgGlucose);
                    }
                }
            });
            
            return result;
        }

        function renderVitalsTable() {
            const tableDiv = document.getElementById('vitalsTable');
            if (!tableDiv) return;
            
            const profileEntries = AppState.healthEntries.filter(e => 
                e.profileId === AppState.currentProfile.id && 
                (e.type === 'vitals' || e.type === 'glucose')
            );
            
            // Sort by timestamp descending (most recent first)
            profileEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Take last 10 entries
            const recentEntries = profileEntries.slice(0, 10);
            
            if (recentEntries.length === 0) {
                tableDiv.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        📊 No vitals logged yet<br>
                        <small>Start tracking to see your history</small>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-tertiary); text-align: left;">
                            <th style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-weight: 600;">Date</th>
                            <th style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-weight: 600;">Type</th>
                            <th style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-weight: 600;">Reading</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recentEntries.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                
                let reading = '';
                let type = '';
                
                if (entry.type === 'vitals') {
                    type = 'Blood Pressure';
                    reading = `${entry.data.systolic}/${entry.data.diastolic} mmHg`;
                } else if (entry.type === 'glucose') {
                    type = 'Blood Sugar';
                    reading = `${entry.data.glucose} mg/dL (${entry.data.timing})`;
                }
                
                tableHTML += `
                    <tr>
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">${dateStr}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">${type}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-weight: 600;">${reading}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableDiv.innerHTML = tableHTML;
        }

        function updateCharts(period) {
            // Update charts based on selected period
            console.log('Updating charts for period:', period);
            // Could expand this to show 30d or 90d data
            renderAnalytics();
        }

        // ===== DATA MANAGEMENT =====
        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const csvText = event.target.result;
                        const lines = csvText.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            showToast('Import failed', 'CSV file is empty', 'error');
                            return;
                        }

                        // Parse header row
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        
                        // Required columns: date, type, value
                        const dateIdx = headers.findIndex(h => h.includes('date'));
                        const typeIdx = headers.findIndex(h => h.includes('type') || h.includes('category'));
                        const valueIdx = headers.findIndex(h => h.includes('value') || h.includes('reading'));
                        const notesIdx = headers.findIndex(h => h.includes('note'));

                        if (dateIdx === -1 || typeIdx === -1 || valueIdx === -1) {
                            showToast('Import failed', 'CSV must have date, type, and value columns', 'error');
                            return;
                        }

                        let imported = 0;
                        let skipped = 0;

                        // Process data rows
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.trim());
                            
                            if (values.length < Math.max(dateIdx, typeIdx, valueIdx) + 1) {
                                skipped++;
                                continue;
                            }

                            const date = values[dateIdx];
                            const type = values[typeIdx].toLowerCase();
                            const value = values[valueIdx];
                            const notes = notesIdx >= 0 ? values[notesIdx] : '';

                            // Validate date
                            const dateObj = new Date(date);
                            if (isNaN(dateObj.getTime())) {
                                skipped++;
                                continue;
                            }

                            // Map type to valid entry types
                            let entryType = 'vitals';
                            let vitalType = '';
                            
                            if (type.includes('blood') || type.includes('bp') || type.includes('pressure')) {
                                entryType = 'vitals';
                                vitalType = 'bloodPressure';
                            } else if (type.includes('glucose') || type.includes('sugar') || type.includes('bs')) {
                                entryType = 'vitals';
                                vitalType = 'bloodSugar';
                            } else if (type.includes('weight')) {
                                entryType = 'vitals';
                                vitalType = 'weight';
                            } else if (type.includes('temp')) {
                                entryType = 'vitals';
                                vitalType = 'temperature';
                            } else if (type.includes('o2') || type.includes('oxygen')) {
                                entryType = 'vitals';
                                vitalType = 'oxygen';
                            } else if (type.includes('med') || type.includes('medication')) {
                                entryType = 'medication';
                            } else if (type.includes('symptom')) {
                                entryType = 'symptom';
                            } else if (type.includes('mood')) {
                                entryType = 'mood';
                            } else {
                                // Default to note
                                entryType = 'note';
                            }

                            // Create health entry
                            const entry = {
                                id: generateId(),
                                profileId: AppState.currentProfile.id,
                                profileName: AppState.currentProfile.name,
                                type: entryType,
                                timestamp: dateObj.toISOString(),
                                notes: notes || value
                            };

                            // Add type-specific data
                            if (entryType === 'vitals' && vitalType) {
                                entry.vitalType = vitalType;
                                entry.value = value;
                            } else if (entryType === 'medication') {
                                entry.medicationName = value;
                            } else if (entryType === 'symptom') {
                                entry.symptom = value;
                                entry.severity = 'moderate';
                            } else if (entryType === 'mood') {
                                entry.mood = value;
                            }

                            AppState.healthEntries.push(entry);
                            imported++;
                        }

                        if (imported > 0) {
                            saveHealthEntries();
                            renderCurrentView();
                            showToast('CSV imported', `${imported} entries added${skipped > 0 ? `, ${skipped} skipped` : ''}`, 'success');
                        } else {
                            showToast('Import failed', 'No valid entries found', 'error');
                        }

                    } catch (error) {
                        console.error('CSV import error:', error);
                        showToast('Import failed', 'Could not parse CSV file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                return;
            }

            localStorage.clear();
            location.reload();
        }

        function saveProfileSettings() {
            const name = document.getElementById('profileNameInput').value;
            const relation = document.getElementById('profileRelationInput').value;
            const dob = document.getElementById('profileDOBInput').value;
            const conditions = document.getElementById('profileConditionsInput').value;

            if (!name) {
                showToast('Error', 'Please enter a name', 'error');
                return;
            }

            AppState.currentProfile.name = name;
            AppState.currentProfile.relation = relation;
            AppState.currentProfile.dateOfBirth = dob;
            AppState.currentProfile.conditions = conditions.split(',').map(c => c.trim()).filter(c => c);
            AppState.currentProfile.avatar = name[0].toUpperCase();

            saveProfiles();
            renderProfileList();
            updateProfileDisplay();

            showToast('Profile updated', 'Your changes have been saved', 'success');
        }

        // ===== ONBOARDING FUNCTIONS =====
        let onboardingRole = null;

        function showOnboarding() {
            showModal('onboardingModal');
            document.getElementById('onboardingStep1').style.display = 'block';
            document.getElementById('onboardingStep2').style.display = 'none';
            document.getElementById('onboardingStep3').style.display = 'none';
        }

        function selectRole(role) {
            onboardingRole = role;
            document.getElementById('onboardingStep1').style.display = 'none';
            document.getElementById('onboardingStep2').style.display = 'block';
            
            // Pre-fill relation based on role
            const relationSelect = document.getElementById('onboardingRelation');
            if (role === 'patient') {
                relationSelect.value = 'self';
            }
            
            // Focus on name input
            setTimeout(() => {
                document.getElementById('onboardingName').focus();
            }, 100);
        }

        function toggleRole() {
            if (!AppState.currentProfile) {
                showToast('No profile selected', 'Please create or select a profile first', 'warning');
                return;
            }

            const currentRole = AppState.currentProfile.role || 'patient';
            const newRole = currentRole === 'patient' ? 'caretaker' : 'patient';
            
            // Update role
            AppState.currentProfile.role = newRole;
            localStorage.setItem('embermate_role', newRole);
            
            // Update all profiles in storage
            const profiles = AppState.profiles.map(p => {
                if (p.id === AppState.currentProfile.id) {
                    return { ...p, role: newRole };
                }
                return p;
            });
            localStorage.setItem('embermate_profiles', JSON.stringify(profiles));
            
            // Update toggle button
            updateRoleToggleUI(newRole);
            
            // Re-render current view
            renderCurrentView();
            
            const roleLabel = newRole === 'caretaker' ? 'caretaker' : 'patient';
            showToast('View switched', `Now in ${roleLabel} mode 👥`, 'info');
        }

        function updateRoleToggleUI(role) {
            const indicator = document.getElementById('roleIndicator');
            const icon = document.getElementById('roleIndicatorIcon');
            const text = document.getElementById('roleIndicatorText');
            const caregiverActions = document.getElementById('caregiverQuickActions');
            
            if (role === 'caretaker') {
                // Caretaker mode
                icon.textContent = '👥';
                text.textContent = 'Caretaker';
                indicator.className = 'role-indicator role-caretaker';
                indicator.setAttribute('aria-label', 'Switch to patient view');
                
                // Show caregiver quick actions
                if (caregiverActions) {
                    caregiverActions.style.display = 'block';
                }
            } else {
                // Patient mode
                icon.textContent = '👤';
                text.textContent = 'Patient';
                indicator.className = 'role-indicator role-patient';
                indicator.setAttribute('aria-label', 'Switch to caretaker view');
                
                // Hide caregiver quick actions
                if (caregiverActions) {
                    caregiverActions.style.display = 'none';
                }
            }
            
            // Update mode-aware home button (V2.12)
            updateModeHomeButton();
        }

        function onboardingBack(toStep) {
            if (toStep === 1) {
                document.getElementById('onboardingStep2').style.display = 'none';
                document.getElementById('onboardingStep1').style.display = 'block';
            } else if (toStep === 2) {
                document.getElementById('onboardingStep3').style.display = 'none';
                document.getElementById('onboardingStep2').style.display = 'block';
            }
        }

        function onboardingCreateProfile() {
            const name = document.getElementById('onboardingName').value.trim();
            const relation = document.getElementById('onboardingRelation').value;

            if (!name) {
                showToast('Please enter a name', 'We need a name for the profile', 'error');
                return;
            }

            // Create the profile with role
            const profile = {
                id: generateId(),
                name: name,
                avatar: name[0].toUpperCase(),
                relation: relation,
                role: onboardingRole || 'patient', // Add role from onboarding selection
                dateOfBirth: '',
                conditions: [],
                createdAt: new Date().toISOString()
            };

            AppState.profiles.push(profile);
            AppState.currentProfile = profile;
            saveProfiles();

            // Customize step 4 based on role
            const isCaretaker = onboardingRole === 'caretaker';
            document.getElementById('onboardingStep4Title').textContent = 
                isCaretaker ? `Here's how you'll support ${name}` : `Here's what you can track`;
            document.getElementById('onboardingStep4Subtitle').textContent = 
                isCaretaker ? `Quick actions designed for caregivers` : `EmberMate helps you log health updates easily`;
            document.getElementById('onboardingMedsDesc').textContent = 
                isCaretaker ? `One-tap "Meds Done" button for their daily medications` : `Quick "Mark as done" for daily meds`;
            document.getElementById('onboardingVitalsDesc').textContent = 
                isCaretaker ? `Log their vitals and get alerts for unusual readings` : `Blood pressure, glucose, weight, and more`;
            document.getElementById('onboardingMoodDesc').textContent = 
                isCaretaker ? `Note how they're feeling and any symptoms` : `Track how you're feeling each day`;

            // Move to step 4
            document.getElementById('onboardingStep3').style.display = 'none';
            document.getElementById('onboardingStep4').style.display = 'block';
        }

        function finishOnboarding() {
            // Mark onboarding as complete
            localStorage.setItem('embermate_onboarding_completed', 'true');
            
            // Close modal
            document.getElementById('onboardingModal').style.display = 'none';
            
            // Initialize the rest of the app
            setupEventListeners();
            
            // Initialize role toggle button to match profile role
            const currentRole = AppState.currentProfile.role || 'patient';
            updateRoleToggleUI(currentRole);
            
            // Load sample data and render
            initializeSampleData();
            renderCurrentView();
            
            // Welcome message with role context
            const roleMessage = currentRole === 'caretaker' 
                ? `👥 You're in caretaker mode. Use the toggle in the header to switch to patient view anytime.`
                : `👤 You're in patient mode. Use the toggle in the header to switch to caretaker view if you're helping someone else.`;
            
            showToast('Welcome to EmberMate! 🎉', roleMessage, 'success');
            
            // Show quick tour after brief delay
            setTimeout(() => {
                showWelcomeTour();
            }, 2000);
        }
        
        function showWelcomeTour() {
            // Simple overlay highlighting key features
            const tourHTML = `
                <div id="welcomeTour" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); max-width: 500px; padding: 2rem; box-shadow: var(--shadow-lg);">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Quick Tour 🗺️</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <span style="font-size: 1.5rem;">👥</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Role Toggle</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Switch between patient and caretaker views in the header</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <span style="font-size: 1.5rem;">👤</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Profile Switcher</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Manage multiple people's health data - click the profile button to add more</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <span style="font-size: 1.5rem;">➕</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Quick Add Button</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Floating button in bottom-right to log anything quickly</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <span style="font-size: 1.5rem;">📊</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Sample Data Loaded</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">We've added some demo entries so you can explore. Delete them anytime!</div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="closeTour()" style="width: 100%;">Got it, let's go!</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', tourHTML);
        }
        
        function closeTour() {
            const tour = document.getElementById('welcomeTour');
            if (tour) tour.remove();
        }

        // ===== UTILITY FUNCTIONS =====
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // PHI Guard - warns about potential sensitive info in notes
        function checkForPHI(text) {
            if (!text || text.length === 0) return null;
            
            // Length check
            if (text.length > 300) {
                return {
                    detected: true,
                    type: 'length',
                    message: 'Note is very long. Consider keeping notes brief and general to protect privacy.'
                };
            }
            
            // Pattern checks for common PHI indicators
            const patterns = {
                ssn: /\b\d{3}-?\d{2}-?\d{4}\b/,
                phone: /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/,
                email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/,
                dob: /\b(0?[1-9]|1[0-2])[\/\-](0?[1-9]|[12]\d|3[01])[\/\-](\d{2}|\d{4})\b/,
                mrn: /\b(MRN|medical record|patient id|account number)[\s:]*\d+/i,
                address: /\b\d+\s+[A-Z][a-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd)\b/i
            };
            
            for (const [type, pattern] of Object.entries(patterns)) {
                if (pattern.test(text)) {
                    return {
                        detected: true,
                        type: type,
                        message: 'This note may contain sensitive personal information. EmberMate is a personal tracker, not a secure medical record.'
                    };
                }
            }
            
            return null;
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getTomorrowDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true
            });
        }

        // Placeholder functions for appointments and medication management
        function showAddMedicationModal() {
            showToast('Coming soon', 'Medication management feature', 'info');
        }

        function showAddAppointmentModal() {
            showToast('Coming soon', 'Appointment scheduling feature', 'info');
        }

        function logMedication(medName) {
            showToast('Logged', `${medName} marked as taken`, 'success');
        }

        // ===== MODE-AWARE HOME (V2.12) =====
        function goToModeHome() {
            const currentRole = AppState.currentProfile.role || 'patient';
            switchTab('healthLog');
            
            if (currentRole === 'caregiver') {
                setTimeout(() => {
                    const caregiverSection = document.getElementById('caregiverQuickActions');
                    if (caregiverSection) {
                        caregiverSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        function updateModeHomeButton() {
            const currentRole = AppState.currentProfile.role || 'patient';
            const btn = document.getElementById('modeHomeBtn');
            const icon = document.getElementById('modeHomeIcon');
            const text = document.getElementById('modeHomeBtnText');
            
            if (currentRole === 'caregiver') {
                icon.textContent = '🏥';
                text.textContent = 'Caregiver Home';
            } else {
                icon.textContent = '🏠';
                text.textContent = 'My Health';
            }
        }

        // ===== DATA IMPORT ONBOARDING (V2.12) =====
        let onboardingDataImportChoice = 'fresh';

        function selectDataImport(choice) {
            onboardingDataImportChoice = choice;
            
            if (choice === 'previous') {
                // Trigger file import
                closeModal('onboardingModal');
                importAllData();
                return;
            }
            
            // Continue to profile creation
            document.getElementById('onboardingStep2').style.display = 'none';
            document.getElementById('onboardingStep3').style.display = 'block';
        }

        // ===== DEBUG/QA PANEL (V2.12 + UC10) =====
        function initDebugPanel() {
            // Check URL param or keyboard shortcut
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('debug') === '1') {
                showDebugPanel();
            }

            // Keyboard shortcut: Ctrl+Shift+D (Cmd+Shift+D on Mac) - UC10
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    toggleDebugPanel();
                }
            });
        }

        function toggleDebugPanel() {
            const debugTab = document.getElementById('debugNavTab');
            if (debugTab && debugTab.style.display === 'flex') {
                hideDebugPanel();
            } else {
                showDebugPanel();
            }
        }

        function showDebugPanel() {
            const debugTab = document.getElementById('debugNavTab');
            if (debugTab) {
                debugTab.style.display = 'flex';
                switchTab('debug');
                refreshDebugInfo();
                showToast('Debug Mode', 'Developer panel activated', 'info');
                
                // Add visual DEV indicator to header
                showDevModeIndicator();
            }
        }

        function hideDebugPanel() {
            const debugTab = document.getElementById('debugNavTab');
            if (debugTab) {
                debugTab.style.display = 'none';
                
                // Remove DEV indicator
                const devChip = document.getElementById('devModeChip');
                if (devChip) {
                    devChip.remove();
                }
                
                // Switch to health log if currently on debug
                if (AppState.currentTab === 'debug') {
                    switchTab('healthLog');
                }
                
                showToast('Debug Mode', 'Developer panel deactivated', 'info');
            }
        }

        function showDevModeIndicator() {
            // Check if indicator already exists
            if (document.getElementById('devModeChip')) return;
            
            const header = document.querySelector('.app-header-top');
            if (!header) return;
            
            const devChip = document.createElement('div');
            devChip.id = 'devModeChip';
            devChip.style.cssText = `
                position: fixed;
                top: 1rem;
                right: 1rem;
                background: var(--warning);
                color: var(--text-inverse);
                padding: 0.25rem 0.625rem;
                border-radius: var(--radius-full);
                font-size: 0.75rem;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            `;
            devChip.textContent = 'DEV';
            devChip.title = 'Debug mode active';
            
            document.body.appendChild(devChip);
        }

        function refreshDebugInfo() {
            document.getElementById('debug-version').textContent = APP_VERSION;
            document.getElementById('debug-profile').textContent = AppState.currentProfile.name || '-';
            document.getElementById('debug-profile-count').textContent = AppState.profiles.length;
            document.getElementById('debug-role').textContent = AppState.currentProfile.role || 'patient';
            
            const totalEntries = Object.values(AppState.entries).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('debug-entries').textContent = totalEntries;
            
            const archivedEntries = Object.values(AppState.archivedEntries || {}).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('debug-archived').textContent = archivedEntries;
            
            // Calculate localStorage usage
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length + key.length;
                }
            }
            const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
            document.getElementById('debug-storage').textContent = `${sizeMB} MB`;
            
            const lastUpdate = localStorage.getItem('lastUpdate') || 'Never';
            document.getElementById('debug-last-update').textContent = lastUpdate === 'Never' ? lastUpdate : new Date(lastUpdate).toLocaleString();
        }

        function addTestData() {
            const profile = AppState.currentProfile;
            const types = ['medication', 'vitals', 'mood', 'symptom', 'appointment'];
            
            for (let i = 0; i < 50; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const entry = {
                    id: Date.now() + i,
                    type: type,
                    timestamp: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                    profileId: profile.id,
                    data: { note: `Test ${type} entry ${i + 1}` }
                };
                
                if (!AppState.entries[profile.id]) {
                    AppState.entries[profile.id] = [];
                }
                AppState.entries[profile.id].push(entry);
            }
            
            saveData();
            renderHealthLog();
            showToast('Test Data', '50 test entries added', 'success');
            refreshDebugInfo();
        }

        function addMassData() {
            const profile = AppState.currentProfile;
            const types = ['medication', 'vitals', 'mood'];
            
            for (let i = 0; i < 1000; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const entry = {
                    id: Date.now() + i,
                    type: type,
                    timestamp: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString(),
                    profileId: profile.id,
                    data: { note: `Mass test entry ${i + 1}` }
                };
                
                if (!AppState.entries[profile.id]) {
                    AppState.entries[profile.id] = [];
                }
                AppState.entries[profile.id].push(entry);
            }
            
            saveData();
            renderHealthLog();
            showToast('Mass Data', '1000 entries added - archiving may trigger', 'info');
            refreshDebugInfo();
        }

        function simulateArchive() {
            const profile = AppState.currentProfile;
            if (!AppState.entries[profile.id] || AppState.entries[profile.id].length < 100) {
                showToast('Not Enough Data', 'Add more entries first (need 1000+)', 'error');
                return;
            }
            
            // Manually trigger archive
            const entries = AppState.entries[profile.id];
            if (entries.length > APP_CONFIG.MAX_ENTRIES_PER_PROFILE) {
                const entriesToArchive = entries.length - APP_CONFIG.MAX_ENTRIES_PER_PROFILE;
                entries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const archived = entries.splice(0, entriesToArchive);
                
                if (!AppState.archivedEntries) {
                    AppState.archivedEntries = {};
                }
                if (!AppState.archivedEntries[profile.id]) {
                    AppState.archivedEntries[profile.id] = [];
                }
                AppState.archivedEntries[profile.id].push(...archived);
                
                saveData();
                renderHealthLog();
                showToast('Archive', `${entriesToArchive} entries archived`, 'success');
                refreshDebugInfo();
            } else {
                showToast('No Archive Needed', `Only ${entries.length} entries (need 1000+)`, 'info');
            }
        }

        function testPHIWarnings() {
            const testStrings = [
                'Call me at 555-123-4567',
                'My email is test@example.com',
                'SSN: 123-45-6789',
                'Born on 01/15/1980',
                'Address: 123 Main St',
                'MRN: MR123456'
            ];
            
            alert('Testing PHI detection:\n\n' + testStrings.map((str, i) => 
                `${i + 1}. "${str}" - ${checkForPHI(str).detected ? '⚠️ DETECTED' : '✓ Clear'}`
            ).join('\n'));
        }

        // UC9: Seed demo vitals with varying BP values for chart testing
        function seedDemoVitals() {
            const profile = AppState.currentProfile;
            const vitalsData = [
                { systolic: 120, diastolic: 80, hoursAgo: 2 },
                { systolic: 125, diastolic: 82, hoursAgo: 6 },
                { systolic: 118, diastolic: 78, hoursAgo: 12 },
                { systolic: 130, diastolic: 85, hoursAgo: 24 },
                { systolic: 122, diastolic: 81, hoursAgo: 36 }
            ];
            
            vitalsData.forEach((vital, index) => {
                const timestamp = new Date(Date.now() - vital.hoursAgo * 60 * 60 * 1000).toISOString();
                const entry = {
                    id: Date.now() + index,
                    type: 'vitals',
                    profileId: profile.id,
                    profileName: profile.name,
                    timestamp: timestamp,
                    data: { systolic: vital.systolic, diastolic: vital.diastolic },
                    content: `Blood pressure: ${vital.systolic}/${vital.diastolic} mmHg`,
                    notes: 'Demo reading'
                };
                
                AppState.healthEntries.push(entry);
            });
            
            saveHealthEntries();
            renderHealthLog();
            
            // Update analytics if visible
            if (AppState.currentTab === 'analytics') {
                renderAnalytics();
            }
            
            showToast('Demo Vitals', '5 BP readings added for UC9 testing', 'success');
            refreshDebugInfo();
        }
    </script>
</body>
</html>
